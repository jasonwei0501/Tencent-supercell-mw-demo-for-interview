<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çš‡å®¤æˆ˜äº‰ï¼šå¤±è½ç‹å›½</title>
    <link rel="stylesheet" href="https://unpkg.com/tdesign-vue-next/dist/tdesign.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .stat-item {
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .main-menu {
            text-align: center;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .menu-title {
            color: white;
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .menu-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 18px;
            margin-bottom: 30px;
        }

        .menu-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .menu-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .phase-container {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .phase-container.active {
            display: block;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* æˆ˜æ–—å‡†å¤‡é˜¶æ®µæ ·å¼ */
        .preparation-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card-selection {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
        }

        .selected-cards {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
        }

        .card-grid, .mp-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .card-item, .mp-mini-card {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            color: #1f2937;
            font-size: 12px;
        }

        .card-item:hover, .mp-mini-card:hover {
            background: #e5e7eb;
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        .card-item.selected, .mp-mini-card.selected {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #1e40af;
        }

        .battle-grid, .mp-grid {
            display: grid;
            grid-template-columns: repeat(6, 50px);
            grid-template-rows: repeat(6, 50px);
            gap: 2px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin: 0 auto;
            width: fit-content;
        }
        
        /* é’ˆå¯¹é˜²å®ˆç½‘æ ¼çš„ç‰¹å®šä¿®æ­£ */
        #defense-grid {
            background: rgba(0,0,0,0.1);
        }

        .grid-cell {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        /* é˜²å®ˆç½‘æ ¼èƒŒæ™¯ä¿®æ­£ */
        #defense-grid .grid-cell {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .grid-cell:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .grid-cell.occupied {
            background: rgba(0, 82, 217, 0.15);
            border-color: rgba(0, 82, 217, 0.4);
        }

        /* ç§¯æœ¨åµŒå…¥çš„å¿«æ„ŸåŠ¨ç”» */
        @keyframes snap-in {
            0% { transform: scale(1.3) rotate(5deg); opacity: 0.6; }
            30% { transform: scale(0.9) rotate(-3deg); opacity: 0.8; }
            60% { transform: scale(1.1) rotate(1deg); opacity: 1; }
            80% { transform: scale(0.98) rotate(-0.5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .grid-cell.occupied .placed-card {
            animation: snap-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .placed-card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .start-battle-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .start-battle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        /* æˆ˜æ–—é˜¶æ®µæ ·å¼ */
        .battle-field {
            background: linear-gradient(to bottom, #22c55e, #16a34a);
            border-radius: 8px;
            height: 400px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
        }

        .battle-unit {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            transition: left 0.2s cubic-bezier(0.4, 0, 0.2, 1), top 0.2s cubic-bezier(0.4, 0, 0.2, 1), transform 0.15s ease-out;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            animation: breathing 2.5s ease-in-out infinite;
            font-size: 20px;
            line-height: 24px;
            text-align: center;
            pointer-events: none;
            user-select: none;
        }

        .battle-unit.player {
            filter: drop-shadow(0 0 2px rgba(0, 82, 217, 0.8));
            background: rgba(0, 123, 255, 0.1);
        }

        .battle-unit.enemy {
            filter: drop-shadow(0 0 2px rgba(220, 38, 38, 0.8));
            background: rgba(255, 123, 123, 0.1);
            transform: scaleX(-1);
        }

        @keyframes breathing {
            0%, 100% { transform: scale(1) translateY(0px); border-radius: 50%; }
            25% { transform: scale(1.05) translateY(-1px); border-radius: 48%; }
            50% { transform: scale(1.1) translateY(-2px); border-radius: 45%; }
            75% { transform: scale(1.05) translateY(-1px); border-radius: 48%; }
        }

        .battle-unit.attacking {
            animation: unitAttack 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes unitAttack {
            0% { transform: scale(1) translateY(0px) rotate(0deg); border-radius: 50%; }
            20% { transform: scale(0.8, 1.2) translateY(3px) rotate(-3deg); border-radius: 40%; }
            40% { transform: scale(1.4, 0.7) translateY(-5px) rotate(5deg); border-radius: 60%; }
            60% { transform: scale(1.2, 0.9) translateY(-2px) rotate(-1deg); border-radius: 50%; }
            80% { transform: scale(0.95, 1.05) translateY(1px) rotate(1deg); border-radius: 48%; }
            100% { transform: scale(1) translateY(0px) rotate(0deg); border-radius: 50%; }
        }

        .battle-unit.hit {
            animation: unitHit 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes unitHit {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            15% { transform: scale(1.3, 0.8) rotate(15deg); opacity: 0.9; }
            30% { transform: scale(0.7, 1.4) rotate(-20deg); opacity: 0.7; }
            45% { transform: scale(1.2, 0.6) rotate(10deg); opacity: 0.5; }
            60% { transform: scale(0.8, 1.2) rotate(-5deg); opacity: 0.3; }
            75% { transform: scale(1.1, 0.9) rotate(2deg); opacity: 0.1; }
            100% { transform: scale(0) rotate(0deg); opacity: 0; }
        }

        .explosion {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle, #fff 0%, #ff6b6b 20%, #ff4757 60%, transparent 100%);
            animation: explode 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
        }

        @keyframes explode {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            25% { transform: scale(0.8) rotate(90deg); opacity: 1; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 0.8; }
            75% { transform: scale(1.5) rotate(270deg); opacity: 0.4; }
            100% { transform: scale(2) rotate(360deg); opacity: 0; }
        }

        .damage-number {
            position: absolute;
            color: #ff4757;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            animation: damageFloat 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            pointer-events: none;
            z-index: 101;
        }

        @keyframes damageFloat {
            0% { transform: translateY(0px) scale(0.5); opacity: 0; }
            20% { transform: translateY(-8px) scale(1.2); opacity: 1; }
            50% { transform: translateY(-20px) scale(1); opacity: 1; }
            100% { transform: translateY(-45px) scale(0.8); opacity: 0; }
        }

        .battle-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: white;
            flex-wrap: wrap;
            gap: 10px;
        }

        .speed-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .speed-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .speed-btn.active {
            background: rgba(59, 130, 246, 0.6);
            border-color: #3b82f6;
        }

        .speed-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* å¾®ä¿¡å°ç¨‹åºé£æ ¼ */
        .miniprogram-container {
            background: #f5f5f5;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }

        .mp-header {
            background: linear-gradient(135deg, #07c160 0%, #06ae56 100%);
            color: white;
            padding: 20px 15px 15px;
            position: relative;
        }

        .mp-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background: rgba(0, 0, 0, 0.05);
        }

        .mp-title {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
        }

        .mp-subtitle {
            font-size: 14px;
            opacity: 0.9;
            text-align: center;
        }

        .mp-content {
            padding: 15px;
        }

        .mp-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mp-button {
            background: #07c160;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            text-align: center;
        }

        .mp-button:hover {
            background: #06ae56;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(7, 193, 96, 0.3);
        }

        .mp-button:active {
            transform: translateY(0);
        }

        .mp-button.secondary {
            background: #f2f2f2;
            color: #333;
        }

        .mp-button.secondary:hover {
            background: #e8e8e8;
        }

        .mp-button.danger {
            background: #ff4757;
        }

        .mp-button.danger:hover {
            background: #ff3838;
        }

        .mp-button.primary {
            background: #3b82f6;
        }
        
        .mp-button.primary:hover {
            background: #2563eb;
        }

        .mp-grid {
            display: grid;
            gap: 12px;
        }

        .mp-grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .mp-grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .mp-stats {
            display: flex;
            justify-content: space-between;
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .mp-stat-item {
            text-align: center;
        }

        .mp-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #059669;
        }

        .mp-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .mp-battle-field {
            background: linear-gradient(to bottom, #d4f4dd 0%, #a8e6b8 100%);
            border-radius: 12px;
            height: 300px;
            position: relative;
            overflow: hidden;
            margin: 15px 0;
            border: 2px solid #c3e6d0;
        }

        .mp-menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .mp-menu-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mp-menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .mp-menu-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .mp-menu-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .mp-menu-desc {
            font-size: 12px;
            color: #6b7280;
        }

        .mp-friend-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .mp-friend-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mp-friend-avatar {
            font-size: 24px;
        }

        .mp-friend-details {
            font-size: 14px;
        }

        .mp-friend-name {
            font-weight: 600;
            color: #333;
        }

        .mp-friend-faction {
            font-size: 12px;
            color: #999;
        }

        .mp-action-buttons {
            display: flex;
            gap: 8px;
        }

        .mp-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mp-territory {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .mp-territory-info {
            flex: 1;
        }

        .mp-territory-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .mp-territory-status {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .mp-territory-resource {
            font-size: 12px;
            color: #07c160;
            font-weight: 500;
        }

        .mp-world-map {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e8e8e8;
            position: relative;
            height: 320px;
            overflow: hidden;
        }

        .mp-territory-map-item {
            position: absolute;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 11px;
            width: 70px;
            height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .mp-territory-map-item.purified {
            background: linear-gradient(135deg, #d4f4dd 0%, #a8e6b8 100%);
            border-color: #07c160;
        }

        .mp-territory-map-item.enemy {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-color: #ff4757;
        }

        .mp-territory-map-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .mp-tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            padding: 8px 0;
            z-index: 1000;
        }

        .mp-tab-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #999;
            font-size: 12px;
        }

        .mp-tab-item.active {
            color: #07c160;
        }

        .mp-tab-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .mp-page {
            padding-bottom: 60px; /* ä¸ºåº•éƒ¨å¯¼èˆªç•™ç©ºé—´ */
            display: none; /* é»˜è®¤éšè—æ‰€æœ‰é¡µé¢ */
        }

        .mp-page.active {
            display: block; /* åªæ˜¾ç¤ºæ¿€æ´»çš„é¡µé¢ */
        }

        .battle-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .battle-log-item {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            margin-bottom: 5px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        /* ç¤¾äº¤ç³»ç»Ÿæ ·å¼ */
        .social-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            color: white;
        }

        .faction-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .faction-btn {
            padding: 10px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .faction-btn.active {
            background: rgba(59, 130, 246, 0.5);
            border-color: #3b82f6;
        }

        .faction-btn.goblin.active {
            background: rgba(239, 68, 68, 0.5);
            border-color: #ef4444;
        }

        .friends-list {
            margin-top: 20px;
        }

        .friend-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .help-btn {
            background: #22c55e;
            color: white;
        }

        .betray-btn {
            background: #ef4444;
            color: white;
        }

        .social-feed {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .feed-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* é¢†åœŸç³»ç»Ÿæ ·å¼ */
        .territory-map {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .world-map {
            background: linear-gradient(135deg, #374151, #1f2937);
            border-radius: 8px;
            height: 400px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
        }

        .territory {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            text-align: center;
            padding: 5px;
        }

        .territory:hover {
            transform: scale(1.1);
        }

        .territory.purified {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-color: #22c55e;
        }

        .territory.enemy {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #ef4444;
        }

        .territory-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
        }

        .territory-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conquer-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .defense-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .preparation-container {
                grid-template-columns: 1fr;
            }
            
            .menu-title {
                font-size: 28px;
            }
            
            .battle-grid {
                grid-template-columns: repeat(6, 40px);
                grid-template-rows: repeat(6, 40px);
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        /* å…³å¡å¼•å¯¼å°çº¢ç‚¹åŠ¨ç”» */
        @keyframes pulse-dot {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }
        }

        /* èƒœåˆ©å¼¹è·³åŠ¨ç”» */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            25% {
                transform: translateY(-20px) scale(1.1);
            }
            50% {
                transform: translateY(0) scale(1);
            }
            75% {
                transform: translateY(-10px) scale(1.05);
            }
        }

        /* å…³å¡è§£é”è¿çº¿åŠ¨ç”» */
        .unlock-connection {
            position: absolute;
            background: linear-gradient(90deg, transparent, #ef4444, transparent);
            height: 2px;
            transform-origin: left center;
            animation: connection-pulse 2s infinite;
            pointer-events: none;
            z-index: 5;
        }

        @keyframes connection-pulse {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 0.8;
            }
        }

        /* å…³å¡è§£é”ç‰¹æ•ˆ */
        .level-unlock-effect {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 3px solid #fbbf24;
            border-radius: 50%;
            pointer-events: none;
            animation: unlock-ring 1.5s ease-out forwards;
            z-index: 20;
        }

        /* å¤±è´¥ç•Œé¢æ ·å¼ */
        .failure-interface {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #fecaca;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.1);
        }

        .failure-title {
            font-size: 24px;
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 15px;
        }

        .failure-description {
            font-size: 16px;
            color: #7f1d1d;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .failure-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .retry-button {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 180px;
        }

        .retry-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .back-to-menu-button {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 180px;
        }

        .back-to-menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.3);
        }

        @keyframes unlock-ring {
            0% {
                transform: scale(0.5);
                opacity: 0;
                border-color: #ef4444;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
                border-color: #f59e0b;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
                border-color: #10b981;
            }
        }
    </style>
</head>
<body>
    <div class="miniprogram-container">
        <div class="mp-header">
            <div class="mp-title">çš‡å®¤æˆ˜äº‰ï¼šå¤±è½ç‹å›½</div>
            <div class="mp-subtitle">èƒŒåŒ…æ•´ç† | ç™¾äººåŒå± | ç¤¾äº¤æ•´æ´» | é¢†åœŸå¾æœ</div>
        </div>

        <div class="mp-content">

        <div id="main-menu" class="mp-page active">
            <div class="mp-stats">
                <div class="mp-stat-item">
                    <div class="mp-stat-value">ğŸ’° <span id="gold">500</span></div>
                    <div class="mp-stat-label">é‡‘å¸</div>
                </div>
                <div class="mp-stat-item">
                    <div class="mp-stat-value" id="faction-display">ğŸ›¡ï¸ éª‘å£«</div>
                    <div class="mp-stat-label">é˜µè¥</div>
                </div>
                <div class="mp-stat-item">
                    <div class="mp-stat-value">âš”ï¸ 0</div>
                    <div class="mp-stat-label">èƒœåˆ©</div>
                </div>
            </div>

            <div class="mp-menu-grid">
                <div class="mp-menu-item" onclick="showPhase('territory')">
                    <div class="mp-menu-icon">ğŸ—ºï¸</div>
                    <div class="mp-menu-title">å…³å¡æŒ‘æˆ˜</div>
                    <div class="mp-menu-desc">æ”¶å¤å¤±è½çš„ç‹å›½</div>
                </div>
                <div class="mp-menu-item" onclick="showPhase('social')">
                    <div class="mp-menu-icon">ğŸ‘¥</div>
                    <div class="mp-menu-title">ç¤¾äº¤ç³»ç»Ÿ</div>
                    <div class="mp-menu-desc">èƒŒå›ä¸è”ç›Ÿ</div>
                </div>
                <div class="mp-menu-item" onclick="showPhase('about')">
                    <div class="mp-menu-icon">ğŸ“–</div>
                    <div class="mp-menu-title">æ¸¸æˆä»‹ç»</div>
                    <div class="mp-menu-desc">ç©æ³•è¯´æ˜</div>
                </div>
            </div>

            <div class="mp-card" style="margin-top: 20px;">
                <h3 style="color: #1f2937; margin-bottom: 12px; font-size: 16px;">ğŸ® æ¸¸æˆç‰¹è‰²</h3>
                <div style="font-size: 14px; line-height: 1.6; color: #4b5563;">
                    <div style="margin-bottom: 8px;">ğŸ§© <strong style="color: #1f2937;">èƒŒåŒ…æ•´ç†å¤‡æˆ˜</strong> - åŠ¨è„‘ä¸åŠ¨æ‰‹çš„ç­–ç•¥ä¹è¶£</div>
                    <div style="margin-bottom: 8px;">âš”ï¸ <strong style="color: #1f2937;">ç™¾äººåŒå±æˆ˜æ–—</strong> - å²è¯—çº§æˆ˜åœºä½“éªŒ</div>
                    <div style="margin-bottom: 8px;">ğŸ‘¥ <strong style="color: #1f2937;">ç¤¾äº¤èƒŒå›æœºåˆ¶</strong> - å¾®ä¿¡ç¾¤ç‹¼äººæ€</div>
                    <div><strong style="color: #1f2937;">ğŸ—ºï¸ ç®±åº­æ¢ç´¢</strong> - æ”¶å¤å¤±è½çš„ç‹å›½</div>
                </div>
            </div>
        </div>

        <div id="social-phase" class="mp-page">
            <div class="mp-card">
                <button class="mp-button secondary" onclick="showPhase('main-menu')">â† è¿”å›</button>
            </div>

            <div class="mp-card">
                <h2 style="text-align: center; margin-bottom: 20px; color: #333; font-size: 18px;">ç¤¾äº¤ç³»ç»Ÿ</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="mp-button" id="faction-knight" onclick="selectFaction('knight')" style="flex: 1;">
                        ğŸ›¡ï¸ çš‡å®¶éª‘å£«
                    </button>
                    <button class="mp-button secondary" id="faction-goblin" onclick="selectFaction('goblin')" style="flex: 1;">
                        ğŸ‘¹ å“¥å¸ƒæ—
                    </button>
                </div>
                
                <div id="faction-abilities">
                    </div>
            </div>
            
            <div class="mp-card">
                <h3 style="color: #333; margin-bottom: 12px; font-size: 16px;">å¥½å‹åˆ—è¡¨</h3>
                <div id="friends-container">
                    </div>
            </div>
            
            <div class="mp-card">
                <h3 style="color: #333; margin-bottom: 12px; font-size: 16px;">ç¤¾äº¤åŠ¨æ€</h3>
                <div id="social-feed-content" style="max-height: 250px; overflow-y: auto;">
                    <div style="padding: 8px; background: #f8f8f8; border-radius: 6px; font-size: 14px; color: #666;">
                        æ¬¢è¿æ¥åˆ°ç¤¾äº¤ç³»ç»Ÿï¼é€‰æ‹©é˜µè¥å¼€å§‹ä½ çš„ç¤¾äº¤ä¹‹æ—…ã€‚
                    </div>
                </div>
            </div>
        </div>

        <div id="territory-phase" class="mp-page">
            <div id="level-selection-view">
                <div class="mp-card">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #333; font-size: 18px;">ğŸ—ºï¸ å…³å¡æŒ‘æˆ˜</h2>
                    
                    <div class="mp-stats">
                        <div class="mp-stat-item">
                            <div class="mp-stat-value">âš”ï¸ <span id="current-level-display">1</span></div>
                            <div class="mp-stat-label">å½“å‰å…³å¡</div>
                        </div>
                        <div class="mp-stat-item">
                            <div class="mp-stat-value">ğŸ† <span id="completed-count">0</span>/5</div>
                            <div class="mp-stat-label">å·²å®Œæˆ</div>
                        </div>
                        <div class="mp-stat-item">
                            <div class="mp-stat-value">ğŸ’° <span id="total-rewards">0</span></div>
                            <div class="mp-stat-label">æ€»å¥–åŠ±</div>
                        </div>
                        <div class="mp-stat-item">
                            <div class="mp-stat-value">â±ï¸ <span id="income-rate">0</span>/æ—¶</div>
                            <div class="mp-stat-label">æŒç»­æ”¶ç›Š</div>
                        </div>
                    </div>
                    
                    <div class="mp-world-map" id="world-map">
                        </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #f8f8f8; border-radius: 8px;">
                        <h4 style="color: #333; font-size: 14px; margin-bottom: 8px;">ğŸ¯ æ“ä½œè¯´æ˜</h4>
                        <p style="color: #666; font-size: 12px; line-height: 1.5;">
                            ç‚¹å‡»åœ°å›¾ä¸Š<span style="color: #07c160;">å·²è§£é”</span>çš„å…³å¡å¼€å§‹æŒ‘æˆ˜ï¼Œå®Œæˆåè§£é”ä¸‹ä¸€å…³ã€‚
                        </p>
                    </div>
                </div>
            </div>

            <div id="battle-prep-view" style="display: none;">
                </div>
        </div>

        <div id="about-phase" class="mp-page">
            <div class="mp-card">
                <button class="mp-button secondary" onclick="showPhase('main-menu')">â† è¿”å›</button>
            </div>

            <div class="mp-card">
                <h2 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px;">æ¸¸æˆç©æ³•è¯´æ˜</h2>
                
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #059669; font-size: 16px; margin-bottom: 8px;">ğŸ§© èƒŒåŒ…æ•´ç†å¤‡æˆ˜</h3>
                    <p style="color: #4b5563; font-size: 14px; line-height: 1.5;">
                        å°†ä¼ ç»Ÿå¡ç‰Œæ¸¸æˆçš„æ—¶é—´å‹åŠ›è½¬åŒ–ä¸ºç©ºé—´æ‹¼å›¾æŒ‘æˆ˜ã€‚é€‰æ‹©å¡ç‰Œï¼Œåˆç†å¸ƒç½®åœ¨æœ‰é™æ ¼å­ä¸­ï¼Œä½“éªŒæ•´ç†æ”¶çº³çš„ä¹è¶£ã€‚
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <h3 style="color: #059669; font-size: 16px; margin-bottom: 8px;">âš”ï¸ ç™¾äººåŒå±æˆ˜æ–—</h3>
                    <p style="color: #4b5563; font-size: 14px; line-height: 1.5;">
                        ä¸€å¼ å¡ç‰Œå®ä½“åŒ–ä¸ºæ•°åä¸ªå•ä½ï¼Œè‡ªåŠ¨è¿›è¡Œå®æ—¶æˆ˜æ–—ã€‚æ”¯æŒ1xã€2xã€4xå€é€Ÿè§‚çœ‹ï¼Œäº«å—å²è¯—çº§æˆ˜åœºä½“éªŒã€‚
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <h3 style="color: #059669; font-size: 16px; margin-bottom: 8px;">ğŸ‘¥ ç¤¾äº¤èƒŒå›æœºåˆ¶</h3>
                    <p style="color: #4b5563; font-size: 14px; line-height: 1.5;">
                        é€‰æ‹©çš‡å®¶éª‘å£«æˆ–å“¥å¸ƒæ—é˜µè¥ï¼Œä¸å¥½å‹äº’åŠ¨ã€‚å¯ä»¥é€‰æ‹©å¸®åŠ©å¥½å‹(æ¶ˆè€—é‡‘å¸)æˆ–èƒŒå›æ å¤º(è·å¾—é‡‘å¸)ï¼Œä½“éªŒå¾®ä¿¡ç¾¤ç‹¼äººæ€çš„åˆºæ¿€ã€‚
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <h3 style="color: #059669; font-size: 16px; margin-bottom: 8px;">ğŸ—ºï¸ é¢†åœŸå¾æœ</h3>
                    <p style="color: #4b5563; font-size: 14px; line-height: 1.5;">
                        æ”»å‡»è¢«å“¥å¸ƒæ—å é¢†çš„é¢†åœŸï¼ŒæˆåŠŸæ”¶å¤åè·å¾—æŒç»­èµ„æºäº§å‡ºã€‚å»ºç«‹é˜²å¾¡é˜µå‹ä¿æŠ¤ä½ çš„é¢†åœŸï¼Œé‡å»ºå¤±è½ç‹å›½ã€‚
                    </p>
                </div>
            </div>

            <div class="mp-card">
                <h3 style="color: #1f2937; font-size: 16px; margin-bottom: 10px;">ğŸ’¡ æ¸¸æˆç‰¹è‰²</h3>
                <div style="color: #4b5563; font-size: 14px; line-height: 1.6;">
                    <p>â€¢ <strong>é™ç»´æ‰“å‡»</strong>ï¼šé™ä½æ“ä½œé—¨æ§›ï¼Œä¿ç•™ç­–ç•¥å¿«æ„Ÿ</p>
                    <p>â€¢ <strong>ç¤¾äº¤å‡ç»´</strong>ï¼šä»æœºæ¢°äº’åŠ¨åˆ°æƒ…æ„Ÿé©±åŠ¨çš„ç—…æ¯’ä¼ æ’­</p>
                    <p>â€¢ <strong>æ²‰æµ¸ä½“éªŒ</strong>ï¼šç®±åº­è®¾è®¡çš„é«˜çº§æ„Ÿï¼Œæ”¶å¤æ²³å±±çš„æˆå°±æ„Ÿ</p>
                </div>
            </div>

            <div style="margin-top: 30px; text-align: center; opacity: 0.6; font-size: 12px; color: #6b7280;">
                Demo by é­æ˜è½© | 2026<br>
                Built with Passion & Code âœ¨
            </div>
        </div>

        <div class="mp-tab-bar">
            <div class="mp-tab-item active" onclick="showPhase('main-menu')">
                <div class="mp-tab-icon">ğŸ </div>
                <div>é¦–é¡µ</div>
            </div>
            <div class="mp-tab-item" onclick="showPhase('territory')">
                <div class="mp-tab-icon">ğŸ—ºï¸</div>
                <div>é¢†åœŸ</div>
            </div>
            <div class="mp-tab-item" onclick="showPhase('social')">
                <div class="mp-tab-icon">ğŸ‘¥</div>
                <div>ç¤¾äº¤</div>
            </div>
            <div class="mp-tab-item" onclick="showPhase('about')">
                <div class="mp-tab-icon">ğŸ“–</div>
                <div>ç©æ³•</div>
            </div>
        </div>
        </div> </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            gold: 500,
            faction: 'knight',
            selectedCards: [],
            placedCards: [],
            battleUnits: [],
            battleTime: 0,
            battleInterval: null,
            resourceInterval: null,
            battleSpeed: 1, // 1x, 2x, 4x speed
            currentLevel: 1,
            currentTerritory: null,
            lastFailedTerritory: null,
            unlockedLevels: [1], // å·²è§£é”çš„å…³å¡
            territories: [
                { 
                    id: 1, 
                    name: 'å¤±è½çš„ç¥æ®¿', 
                    purified: false, 
                    owner: 'å“¥å¸ƒæ—', 
                    resources: 10, 
                    x: 50, 
                    y: 50,
                    level: 1,
                    enemyCards: [
                        {id: 'enemy_goblin_1', elixirCost: 2, damage: 100, hp: 200, icon: 'ğŸ‘º'},
                        {id: 'enemy_archer_1', elixirCost: 3, damage: 150, hp: 300, icon: 'ğŸ¹'}
                    ],
                    enemyReward: 50,
                    defenseLayout: [] // æ–°å¢ï¼šé˜²å®ˆé˜µå‹
                },
                { 
                    id: 2, 
                    name: 'ç ´ç¢çš„è¿œå¾æ¡¥', 
                    purified: false, 
                    owner: 'å“¥å¸ƒæ—', 
                    resources: 15, 
                    x: 200, 
                    y: 100,
                    level: 2,
                    enemyCards: [
                        {id: 'enemy_goblin_2', elixirCost: 3, damage: 120, hp: 250, icon: 'ğŸ‘º'},
                        {id: 'enemy_archer_2', elixirCost: 3, damage: 160, hp: 320, icon: 'ğŸ¹'},
                        {id: 'enemy_knight_1', elixirCost: 4, damage: 200, hp: 400, icon: 'ğŸ›¡ï¸'}
                    ],
                    enemyReward: 80,
                    defenseLayout: []
                },
                { 
                    id: 3, 
                    name: 'æ·±æ¸Šçš„å“€åšæ´ç©´', 
                    purified: false, 
                    owner: 'å“¥å¸ƒæ—', 
                    resources: 20, 
                    x: 350, 
                    y: 80,
                    level: 3,
                    enemyCards: [
                        {id: 'enemy_goblin_3', elixirCost: 3, damage: 140, hp: 280, icon: 'ğŸ‘º'},
                        {id: 'enemy_archer_3', elixirCost: 4, damage: 180, hp: 350, icon: 'ğŸ¹'},
                        {id: 'enemy_knight_2', elixirCost: 4, damage: 220, hp: 420, icon: 'ğŸ›¡ï¸'}
                    ],
                    enemyReward: 120,
                    defenseLayout: []
                },
                { 
                    id: 4, 
                    name: 'å‡‹é›¶çš„çš‡å®¶åŸå ¡', 
                    purified: false, 
                    owner: 'å“¥å¸ƒæ—', 
                    resources: 25, 
                    x: 150, 
                    y: 250,
                    level: 4,
                    enemyCards: [
                        {id: 'enemy_goblin_4', elixirCost: 4, damage: 160, hp: 300, icon: 'ğŸ‘º'},
                        {id: 'enemy_archer_4', elixirCost: 4, damage: 200, hp: 380, icon: 'ğŸ¹'},
                        {id: 'enemy_knight_3', elixirCost: 5, damage: 250, hp: 450, icon: 'ğŸ›¡ï¸'}
                    ],
                    enemyReward: 160,
                    defenseLayout: []
                },
                { 
                    id: 5, 
                    name: 'æ°¸æ’é¾™ä¹‹å¢“ç©´', 
                    purified: false, 
                    owner: 'å“¥å¸ƒæ—', 
                    resources: 30, 
                    x: 300, 
                    y: 220,
                    level: 5,
                    enemyCards: [
                        {id: 'enemy_goblin_5', elixirCost: 5, damage: 200, hp: 350, icon: 'ğŸ‘º'},
                        {id: 'enemy_archer_5', elixirCost: 5, damage: 240, hp: 420, icon: 'ğŸ¹'},
                        {id: 'enemy_knight_4', elixirCost: 5, damage: 280, hp: 500, icon: 'ğŸ›¡ï¸'},
                        {id: 'enemy_mage_1', elixirCost: 6, damage: 300, hp: 400, icon: 'ğŸ§™'}
                    ],
                    enemyReward: 200,
                    defenseLayout: []
                }
            ],
            friends: [
                { id: 1, name: 'å¼ ä¸‰', faction: 'knight', avatar: 'ğŸ‘¤' },
                { id: 2, name: 'æå››', faction: 'goblin', avatar: 'ğŸ‘¥' },
                { id: 3, name: 'ç‹äº”', faction: 'knight', avatar: 'ğŸ‘¨' }
            ],
            socialFeed: ['æ¬¢è¿æ¥åˆ°ç¤¾äº¤ç³»ç»Ÿï¼']
        };

        // å¡ç‰Œæ•°æ®
        const cards = [
            { id: 1, name: 'å·¨äºº', icon: 'ğŸ§Ÿâ€â™‚ï¸', cost: 5, damage: 50, health: 200, color: '#ef4444', shape: [[1,1],[1,1]], width: 2, height: 2 },
            { id: 2, name: 'å¼“ç®­æ‰‹', icon: 'ğŸ¹', cost: 3, damage: 30, health: 80, color: '#22c55e', shape: [[1]], width: 1, height: 1 },
            { id: 3, name: 'éª‘å£«', icon: 'ğŸ›¡ï¸', cost: 3, damage: 40, health: 120, color: '#3b82f6', shape: [[1,0],[1,1]], width: 2, height: 2 },
            { id: 4, name: 'éª·é«…å…µ', icon: 'ğŸ’€', cost: 1, damage: 20, health: 40, color: '#6b7280', shape: [[1]], width: 1, height: 1 },
            { id: 5, name: 'æ³•å¸ˆ', icon: 'ğŸ§™â€â™‚ï¸', cost: 4, damage: 60, health: 100, color: '#8b5cf6', shape: [[1,1]], width: 2, height: 1 },
            { id: 6, name: 'å…¬ä¸»', icon: 'ğŸ‘¸', cost: 4, damage: 60, health: 60, color: '#ec4899', shape: [[1]], width: 1, height: 1 }
        ];

        // é¡µé¢åˆ‡æ¢
        function showPhase(phase) {
            document.querySelectorAll('.mp-page').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            document.querySelectorAll('.mp-tab-item').forEach(el => {
                el.classList.remove('active');
            });
            
            const phaseId = phase === 'main-menu' ? 'main-menu' : phase + '-phase';
            const targetPhase = document.getElementById(phaseId);
            if (targetPhase) {
                targetPhase.style.display = 'block';
                targetPhase.classList.add('active');
            }
            
            const tabIndex = {'main-menu': 0, 'social': 1, 'territory': 2, 'about': 3};
            if (tabIndex[phase] !== undefined) {
                const tabItems = document.querySelectorAll('.mp-tab-item');
                if (tabItems[tabIndex[phase]]) tabItems[tabIndex[phase]].classList.add('active');
            }
            
            if (phase === 'territory') {
                initTerritory();
            } else if (phase === 'social') {
                initSocial();
            }
        }

        // åˆå§‹åŒ–é¢†åœŸç•Œé¢
        function initTerritory() {
            showLevelSelection();
            renderWorldMap();
            updateTerritoryStats();
        }

        function showLevelSelection() {
            document.getElementById('level-selection-view').style.display = 'block';
            document.getElementById('battle-prep-view').style.display = 'none';
        }

        // æ¸²æŸ“åœ°å›¾
        function renderWorldMap() {
            const worldMap = document.getElementById('world-map');
            worldMap.innerHTML = '';
            
            gameState.territories.forEach((territory, index) => {
                const territoryEl = document.createElement('div');
                territoryEl.className = 'mp-territory-map-item';
                
                const isFirstLevel = territory.level === 1;
                const previousLevelCompleted = territory.level > 1 && 
                    gameState.territories.find(t => t.level === territory.level - 1)?.purified;
                const isUnlocked = isFirstLevel || previousLevelCompleted;
                const isCompleted = territory.purified && territory.owner === 'ç©å®¶';
                
                if (isUnlocked && !gameState.unlockedLevels.includes(territory.level)) {
                    gameState.unlockedLevels.push(territory.level);
                }
                
                if (index === 0 || previousLevelCompleted) {
                    if (!isCompleted && isUnlocked) {
                        territoryEl.style.position = 'relative';
                        territoryEl.innerHTML += `<div class="level-guide-dot" style="position: absolute; top: -8px; right: -8px; width: 12px; height: 12px; background: #ef4444; border-radius: 50%; border: 2px solid white; animation: pulse-dot 2s infinite; z-index: 10;"></div>`;
                    }
                }
                
                if (isCompleted) {
                    territoryEl.classList.add('purified');
                    territoryEl.innerHTML = `<div>âœ…</div><div style="font-weight: 600; font-size: 10px; margin: 2px 0;">${territory.name}</div><div style="color: #07c160; font-size: 9px;">å·²å é¢†</div><div style="color: #f59e0b; font-size: 9px; font-weight: bold;">+${territory.resources}/æ—¶</div>`;
                    territoryEl.onclick = () => showDefenseOptions(territory);
                    territoryEl.style.cursor = 'pointer';
                } else if (isUnlocked) {
                    territoryEl.classList.add('enemy');
                    territoryEl.innerHTML = `<div>âš”ï¸</div><div style="font-weight: 600; font-size: 10px; margin: 2px 0;">${territory.name}</div><div style="color: #ff4757; font-size: 9px;">å¯æŒ‘æˆ˜</div>`;
                    territoryEl.onclick = () => selectLevel(territory);
                    territoryEl.style.cursor = 'pointer';
                } else {
                    territoryEl.classList.add('locked');
                    territoryEl.innerHTML = `<div>ğŸ”’</div><div style="font-weight: 600; font-size: 10px; margin: 2px 0;">${territory.name}</div><div style="color: #999; font-size: 9px;">æœªè§£é”</div>`;
                    territoryEl.style.cursor = 'not-allowed';
                }
                
                territoryEl.style.left = territory.x + 'px';
                territoryEl.style.top = territory.y + 'px';
                worldMap.appendChild(territoryEl);
            });
            updateTerritoryStats();
        }

        // æ˜¾ç¤ºæˆ˜æ–—å‡†å¤‡è§†å›¾
        function showBattlePreparation(territory) {
            document.getElementById('level-selection-view').style.display = 'none';
            const battlePrepView = document.getElementById('battle-prep-view');
            battlePrepView.style.display = 'block';
            
            battlePrepView.innerHTML = `
                <div class="mp-card">
                    <button class="mp-button secondary" onclick="showLevelSelection()">â† è¿”å›å…³å¡é€‰æ‹©</button>
                    <div id="selected-level-info" style="padding: 15px; background: rgba(31, 41, 55, 0.1); border-radius: 8px; margin: 15px 0;"></div>
                </div>
                <div class="mp-card">
                    <h3 style="color: #333; margin-bottom: 15px; font-size: 16px;">é€‰æ‹©å¡ç‰Œ (è´¹ç”¨é™åˆ¶: 10)</h3>
                    <div style="color: #07c160; margin-bottom: 10px; font-weight: 500;">å½“å‰è´¹ç”¨: <span id="current-cost">0</span>/10</div>
                    <div class="card-grid" id="card-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
                </div>
                <div class="mp-card">
                    <h3 style="color: #333; margin-bottom: 15px; font-size: 16px;">æˆ˜åœºå¸ƒç½®</h3>
                    <div class="battle-grid" id="battle-grid" style="margin: 0 auto; width: fit-content;"></div>
                    <button class="mp-button" onclick="startBattle()" style="margin: 15px auto 0; display: block;">å¼€å§‹æˆ˜æ–—</button>
                </div>
            `;
            
            initPreparation();
            
            const levelInfo = document.getElementById('selected-level-info');
            if (levelInfo) {
                levelInfo.innerHTML = `
                    <div style="color: #1f2937; font-size: 16px; font-weight: bold; margin-bottom: 8px;">ğŸ¯ ç¬¬${territory.level}å…³ - ${territory.name}</div>
                    <div style="display: flex; gap: 20px; margin-bottom: 8px;">
                        <div style="color: #666; font-size: 13px;">ğŸ‘¹ æ•Œäºº: ${territory.enemyCards ? territory.enemyCards.length : 0} å¼ å¡ç‰Œ</div>
                        <div style="color: #f59e0b; font-size: 13px;">ğŸ’° å¥–åŠ±: ${territory.enemyReward} é‡‘å¸</div>
                    </div>
                `;
            }
        }

        // åˆå§‹åŒ–å‡†å¤‡é˜¶æ®µ
        function initPreparation() {
            const cardGrid = document.getElementById('card-grid');
            const battleGrid = document.getElementById('battle-grid');
            if (!cardGrid || !battleGrid) return;
            
            cardGrid.innerHTML = '';
            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card-item';
                let shapePreview = '';
                for (let i = 0; i < card.shape.length; i++) {
                    let row = '<div style="display: flex;">';
                    for (let j = 0; j < card.shape[i].length; j++) {
                        row += `<div style="width: 8px; height: 8px; margin: 1px; background: ${card.shape[i][j] ? card.color : 'transparent'}; border: 1px solid rgba(0,0,0,0.2);"></div>`;
                    }
                    row += '</div>';
                    shapePreview += row;
                }
                cardEl.innerHTML = `
                    <div style="background: ${card.color}; width: 30px; height: 30px; margin: 0 auto 5px; border-radius: 4px;"></div>
                    <div style="font-weight: bold;">${card.name}</div>
                    <div>è´¹ç”¨: ${card.cost}</div>
                    <div style="margin: 5px auto;">${shapePreview}</div>
                `;
                cardEl.onclick = () => selectCard(card);
                cardEl.id = `card-${card.id}`;
                cardGrid.appendChild(cardEl);
            });
            
            battleGrid.innerHTML = '';
            for (let i = 0; i < 36; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.onclick = () => placeCard(i);
                cell.id = `cell-${i}`;
                battleGrid.appendChild(cell);
            }
            
            // å¦‚æœæ˜¯é˜²å®ˆæ¨¡å¼ä¸”æœ‰ä¿å­˜çš„é˜µå‹ï¼ŒåŠ è½½å®ƒ
            if (gameState.currentTerritory.defenseLayout && gameState.currentTerritory.defenseLayout.length > 0) {
                 // è¿™æ˜¯ä¸€ä¸ªç®€å•çš„åˆ¤æ–­ï¼Œå®é™…å¯èƒ½éœ€è¦æ›´ä¸¥è°¨çš„ä¸Šä¸‹æ–‡åˆ¤æ–­æ˜¯å¦å¤„äºé˜²å®ˆæ¨¡å¼
                 // ä½†åœ¨ showDefenseSetup ä¸­æˆ‘ä»¬ä¼šæ‰‹åŠ¨è¦†ç›– placedCardsï¼Œæ‰€ä»¥è¿™é‡Œæ¸…ç©ºæ˜¯å®‰å…¨çš„é»˜è®¤è¡Œä¸º
            }

            // é»˜è®¤æ¸…ç©ºï¼Œå…·ä½“æ•°æ®ç”±è°ƒç”¨æ–¹(å¦‚showDefenseSetup)å¡«å……
            gameState.selectedCards = [];
            gameState.placedCards = [];
            updateCost();
        }

        // é€‰æ‹©å…³å¡
        function selectLevel(territory) {
            const isFirstLevel = territory.level === 1;
            const previousLevelCompleted = territory.level > 1 && gameState.territories.find(t => t.level === territory.level - 1)?.purified;
            const isUnlocked = isFirstLevel || previousLevelCompleted;
            
            if (!isUnlocked) {
                addSocialMessage(`è¯·å…ˆå®Œæˆç¬¬${territory.level - 1}å…³æ‰èƒ½è§£é”æ­¤å…³å¡ï¼`);
                return;
            }
            gameState.currentTerritory = territory;
            showBattlePreparation(territory);
            addSocialMessage(`å¼€å§‹æŒ‘æˆ˜ç¬¬${territory.level}å…³ï¼š${territory.name}`);
        }

        // --- é˜²å®ˆ/é‡å»ºç³»ç»Ÿæ ¸å¿ƒé€»è¾‘ ---

        // 1. æ˜¾ç¤ºé¢†åœ°ç®¡ç†ä¸»é¡µ
        function showDefenseOptions(territory) {
            gameState.currentTerritory = territory;
            document.getElementById('level-selection-view').style.display = 'none';
            const battlePrepView = document.getElementById('battle-prep-view');
            battlePrepView.style.display = 'block';
            
            // è®¡ç®—ç¹è£åº¦ï¼ˆåŸºäºé˜²å®ˆå¡ç‰Œæ€»è´¹ç”¨çš„ç®€å•ç®—æ³•ï¼‰
            const defenseScore = territory.defenseLayout ? territory.defenseLayout.reduce((sum, item) => sum + item.card.cost * 10, 0) : 0;
            
            battlePrepView.innerHTML = `
                <div class="mp-card">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #333; font-size: 18px;">ğŸ° ${territory.name}</h2>
                    <div style="padding: 20px; background: #ecfdf5; border: 1px solid #059669; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                        <div style="color: #059669; font-size: 18px; font-weight: bold; margin-bottom: 5px;">âœ… å·²æ”¶å¤å¤±åœ°</div>
                        <div style="color: #059669; font-size: 14px;">ç‹å›½ç¹è£åº¦: ${defenseScore}</div>
                        <div style="color: #f59e0b; font-size: 20px; font-weight: bold; margin-top: 10px;">ğŸ’° ç¨æ”¶ï¼š+${territory.resources} é‡‘å¸/å°æ—¶</div>
                    </div>
                    <div style="display: grid; gap: 10px;">
                        <button class="mp-button primary" onclick="showDefenseSetup(gameState.currentTerritory)">ğŸ›¡ï¸ é‡å»ºé˜²çº¿ / è°ƒæ•´å¸ƒé˜µ</button>
                        <button class="mp-button secondary" onclick="returnToMap()">ğŸ—ºï¸ è¿”å›ä¸–ç•Œåœ°å›¾</button>
                    </div>
                </div>
            `;
        }

        // 2. æ˜¾ç¤ºé˜²å®ˆå¸ƒé˜µç•Œé¢
        function showDefenseSetup(territory) {
            gameState.currentTerritory = territory;
            
            // åˆ‡æ¢è§†å›¾
            document.getElementById('level-selection-view').style.display = 'none';
            const battlePrepView = document.getElementById('battle-prep-view');
            battlePrepView.style.display = 'block';
            
            // æ„å»ºç•Œé¢
            battlePrepView.innerHTML = `
                <div class="mp-card">
                    <button class="mp-button secondary" onclick="showDefenseOptions(gameState.currentTerritory)">â† å–æ¶ˆ</button>
                    <h2 style="text-align: center; margin: 10px 0; color: #333; font-size: 16px;">ğŸ›¡ï¸ é‡å»ºé˜²çº¿ï¼š${territory.name}</h2>
                </div>
                <div class="mp-card">
                    <h3 style="color: #333; margin-bottom: 10px;">1. é€‰æ‹©å®ˆå†› (è´¹ç”¨ <span id="current-cost">0</span>/10)</h3>
                    <div class="card-grid" id="card-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;"></div>
                </div>
                <div class="mp-card">
                    <h3 style="color: #333; margin-bottom: 10px;">2. éƒ¨ç½²é˜²çº¿</h3>
                    <div class="battle-grid" id="battle-grid" style="margin: 0 auto; width: fit-content;"></div>
                    <button class="mp-button primary" style="width: 100%; margin-top: 15px;" onclick="saveDefenseSetup()">ğŸ’¾ ä¿å­˜é˜µå‹ (é‡å»ºç‹å›½)</button>
                </div>
            `;
            
            // åˆå§‹åŒ–å¹¶åŠ è½½å·²æœ‰é˜µå‹
            initPreparation();
            if (territory.defenseLayout && territory.defenseLayout.length > 0) {
                // æ·±æ‹·è´é˜²æ­¢å¼•ç”¨é—®é¢˜
                gameState.placedCards = JSON.parse(JSON.stringify(territory.defenseLayout));
                // é‡æ–°æ¸²æŸ“æ ¼å­ä»¥æ˜¾ç¤ºå·²æœ‰çš„å¡ç‰Œ
                const grid = document.getElementById('battle-grid');
                gameState.placedCards.forEach(p => {
                    placeCardOnGrid(p.card, Math.floor(p.cellIndex / 6), p.cellIndex % 6);
                });
                updateCost();
            }
        }

        // 3. ä¿å­˜é˜²å®ˆé˜µå‹
        function saveDefenseSetup() {
            if (gameState.placedCards.length === 0) {
                alert('è¯·è‡³å°‘éƒ¨ç½²ä¸€ä¸ªå®ˆå«å•ä½æ¥ä¿å«é¢†åœŸï¼');
                return;
            }
            
            // æŒä¹…åŒ–ä¿å­˜
            gameState.currentTerritory.defenseLayout = JSON.parse(JSON.stringify(gameState.placedCards));
            
            alert(`âœ… ${gameState.currentTerritory.name} é˜²çº¿å·²é‡å»ºï¼\nç‹å›½ç¹è£åº¦æå‡ï¼Œç¨æ”¶å°†æŒç»­åˆ°è´¦ã€‚`);
            showDefenseOptions(gameState.currentTerritory);
        }

        // --- é€šç”¨å¡ç‰Œé€»è¾‘ ---

        function selectCard(card) {
            if (gameState.selectedCards.length > 0 && gameState.selectedCards[0].id === card.id) {
                gameState.selectedCards = [];
                document.getElementById(`card-${card.id}`).classList.remove('selected');
                updateCost();
                return;
            }
            const currentBoardCost = gameState.placedCards.reduce((sum, p) => sum + p.card.cost, 0);
            const isAlreadyOnBoard = gameState.placedCards.some(p => p.card.id === card.id);
            const costToAdd = isAlreadyOnBoard ? 0 : card.cost;

            if (currentBoardCost + costToAdd > 10) {
                alert(`å›½åº“èµ„é‡‘ä¸è¶³ï¼å½“å‰å‰©ä½™ ${10 - currentBoardCost} è´¹ï¼Œæ­¤å•ä½éœ€è¦ ${card.cost} è´¹ã€‚`);
                return;
            }
            gameState.selectedCards = [];
            document.querySelectorAll('.card-item').forEach(el => el.classList.remove('selected'));
            gameState.selectedCards.push(card);
            document.getElementById(`card-${card.id}`).classList.add('selected');
            updateCost();
        }

        function placeCard(cellIndex) {
            if (gameState.selectedCards.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦éƒ¨ç½²çš„éƒ¨é˜Ÿï¼');
                return;
            }
            const card = gameState.selectedCards[0];
            const row = Math.floor(cellIndex / 6);
            const col = cellIndex % 6;
            
            if (canPlaceCard(card, row, col)) {
                removePlacedCard(card.id);
                placeCardOnGrid(card, row, col);
                gameState.placedCards.push({ card, cellIndex });
                
                // æ”¾ç½®åè‡ªåŠ¨å–æ¶ˆé€‰ä¸­
                gameState.selectedCards = [];
                document.querySelectorAll('.card-item').forEach(el => el.classList.remove('selected'));
                updateCost();
            }
        }

        function canPlaceCard(card, row, col) {
            for (let i = 0; i < card.shape.length; i++) {
                for (let j = 0; j < card.shape[i].length; j++) {
                    if (card.shape[i][j] === 1) {
                        const gridRow = row + i;
                        const gridCol = col + j;
                        if (gridRow >= 6 || gridCol >= 6 || gridRow < 0 || gridCol < 0) return false;
                        const targetCell = document.getElementById(`cell-${gridRow * 6 + gridCol}`);
                        if (targetCell && targetCell.classList.contains('occupied')) return false;
                    }
                }
            }
            return true;
        }

        function placeCardOnGrid(card, row, col) {
             for (let i = 0; i < card.shape.length; i++) {
                for (let j = 0; j < card.shape[i].length; j++) {
                    if (card.shape[i][j] === 1) {
                        const cell = document.getElementById(`cell-${(row + i) * 6 + (col + j)}`);
                        if (cell) {
                            cell.classList.add('occupied');
                            if (i === 0 && j === 0) {
                                cell.innerHTML = `<div class="placed-card" style="background: ${card.color}; position: absolute; top: 0; left: 0; width: ${card.width * 50}px; height: ${card.height * 50}px; z-index: 10; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">${card.icon}</div>`;
                            } else {
                                cell.innerHTML = `<div style="background: ${card.color}; opacity: 0.5; width: 100%; height: 100%; border-radius: 2px;"></div>`;
                            }
                        }
                    }
                }
            }
        }

        function removePlacedCard(cardId) {
            gameState.placedCards = gameState.placedCards.filter(p => p.card.id !== cardId);
            document.querySelectorAll('.grid-cell').forEach((cell, index) => {
                if (cell.classList.contains('occupied')) {
                    // ç®€å•çš„æ¸…é™¤é€»è¾‘ï¼šå¦‚æœæ²¡æœ‰è¢«ä»»ä½•ç°æœ‰å¡ç‰Œè¦†ç›–ï¼Œå°±æ¸…ç©º
                    // æ›´ä¸¥è°¨çš„åšæ³•æ˜¯é‡ç»˜æ•´ä¸ªç½‘æ ¼ï¼Œè¿™é‡Œä¸ºäº†æ€§èƒ½ç®€åŒ–å¤„ç†ï¼Œä½†åœ¨ removePlacedCard è°ƒç”¨å‰å¿…é¡»ä¿è¯æ•°æ®å·²ç» filter è¿‡äº†
                    // ç”±äº placeCardOnGrid æ˜¯å¢é‡ç»˜åˆ¶ï¼Œæˆ‘ä»¬åœ¨ placeCard ä¸»é€»è¾‘ä¸­åº”è¯¥å…ˆæ¸…ç©ºå—å½±å“çš„åŒºåŸŸæˆ–è€…é‡ç»˜ã€‚
                    // ä¸ºäº†ä¿è¯æ˜¾ç¤ºæ­£ç¡®ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯æ¸…ç©ºæ‰€æœ‰æ ¼å­ç„¶åé‡ç»˜ placedCardsã€‚
                }
            });
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ ¼å­
            const grid = document.getElementById('battle-grid');
            if(grid) {
                Array.from(grid.children).forEach(c => { c.className = 'grid-cell'; c.innerHTML = ''; });
                gameState.placedCards.forEach(p => placeCardOnGrid(p.card, Math.floor(p.cellIndex/6), p.cellIndex%6));
            }
        }

        function updateCost() {
            const placedCost = gameState.placedCards.reduce((sum, p) => sum + p.card.cost, 0);
            let selectedCost = 0;
            if (gameState.selectedCards.length > 0) {
                const card = gameState.selectedCards[0];
                if (!gameState.placedCards.some(p => p.card.id === card.id)) selectedCost = card.cost;
            }
            const total = placedCost + selectedCost;
            const costEl = document.getElementById('current-cost');
            if (costEl) {
                costEl.textContent = total;
                costEl.parentElement.style.color = total > 10 ? '#ef4444' : '#07c160';
            }
        }

        // --- æˆ˜æ–—é€»è¾‘ ---
        function startBattle() {
            if (gameState.placedCards.length === 0) { alert('è¯·è‡³å°‘æ”¾ç½®ä¸€å¼ å¡ç‰Œï¼'); return; }
            initBattleInTerritory();
        }

        function initBattleInTerritory() {
            const battlePrepView = document.getElementById('battle-prep-view');
            battlePrepView.innerHTML = `
                <div class="mp-card">
                    <div class="mp-stats">
                        <div class="mp-stat-item"><div class="mp-stat-value" id="player-units">0</div><div class="mp-stat-label">æˆ‘æ–¹</div></div>
                        <div class="mp-stat-item"><div class="mp-stat-value" id="battle-time">0s</div><div class="mp-stat-label">æ—¶é—´</div></div>
                        <div class="mp-stat-item"><div class="mp-stat-value" id="enemy-units">0</div><div class="mp-stat-label">æ•Œæ–¹</div></div>
                    </div>
                    <div class="mp-battle-field" id="territory-battle-field"></div>
                    <button class="mp-button danger" onclick="endBattle()" style="width: 100%; margin-top: 10px;">ğŸ³ï¸ æ’¤é€€/ç»“æŸ</button>
                </div>
            `;
            
            const battleField = document.getElementById('territory-battle-field');
            gameState.battleUnits = [];
            
            // ç”Ÿæˆå•ä½
            gameState.placedCards.forEach(({ card }) => {
                const count = 5 + Math.floor(Math.random() * 5);
                for(let i=0; i<count; i++) createUnit(battleField, 'player', card.icon, 50 + Math.random()*100, 50 + Math.random()*200, card.damage/3, card.health);
            });
            gameState.currentTerritory.enemyCards.forEach(ec => {
                const count = 3 + Math.floor(Math.random() * 3);
                for(let i=0; i<count; i++) createUnit(battleField, 'enemy', ec.icon, 250 + Math.random()*50, 50 + Math.random()*200, ec.damage/3, ec.hp/2);
            });

            gameState.battleTime = 0;
            gameState.battleInterval = setInterval(gameLoop, 50);
        }

        function createUnit(container, team, icon, x, y, dmg, hp) {
            const el = document.createElement('div');
            el.className = `battle-unit ${team}`;
            el.textContent = icon;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            container.appendChild(el);
            gameState.battleUnits.push({ el, team, x, y, dmg, hp });
        }

        function gameLoop() {
            gameState.battleTime += 0.05;
            document.getElementById('battle-time').textContent = Math.floor(gameState.battleTime) + 's';
            
            const players = gameState.battleUnits.filter(u => u.team === 'player' && u.hp > 0);
            const enemies = gameState.battleUnits.filter(u => u.team === 'enemy' && u.hp > 0);
            document.getElementById('player-units').textContent = players.length;
            document.getElementById('enemy-units').textContent = enemies.length;

            if (players.length === 0 || enemies.length === 0) {
                endBattleResult(players.length > 0);
                return;
            }

            gameState.battleUnits.forEach(u => {
                if(u.hp <= 0) return;
                const targets = u.team === 'player' ? enemies : players;
                let target = null, minDist = 9999;
                targets.forEach(t => {
                    const d = Math.sqrt((u.x - t.x)**2 + (u.y - t.y)**2);
                    if(d < minDist) { minDist = d; target = t; }
                });

                if(target) {
                    if(minDist > 20) {
                        const angle = Math.atan2(target.y - u.y, target.x - u.x);
                        u.x += Math.cos(angle) * 2;
                        u.y += Math.sin(angle) * 2;
                        u.el.style.left = u.x + 'px';
                        u.el.style.top = u.y + 'px';
                    } else {
                        if(Math.random() < 0.1) {
                            target.hp -= u.dmg;
                            u.el.classList.add('attacking');
                            setTimeout(()=>u.el.classList.remove('attacking'), 200);
                            if(target.hp <= 0) {
                                target.el.style.opacity = 0;
                                const boom = document.createElement('div');
                                boom.className = 'explosion';
                                boom.style.left = target.x + 'px';
                                boom.style.top = target.y + 'px';
                                document.getElementById('territory-battle-field').appendChild(boom);
                                setTimeout(()=>boom.remove(), 500);
                            }
                        }
                    }
                }
            });
        }

        function endBattleResult(isWin) {
            clearInterval(gameState.battleInterval);
            const view = document.getElementById('battle-prep-view');
            const territory = gameState.currentTerritory;
            
            view.innerHTML = `
                <div class="mp-card" style="text-align:center; padding:30px;">
                    <div style="font-size:60px;">${isWin ? 'ğŸ‰' : 'â˜ ï¸'}</div>
                    <h2 style="color:${isWin ? '#059669' : '#ef4444'}">${isWin ? 'å¤§è·å…¨èƒœï¼' : 'è¿›æ”»å¤±è´¥'}</h2>
                    <p style="color:#666; margin:10px 0;">${isWin ? `æˆåŠŸæ”¶å¤ ${territory.name}ï¼<br>è·å¾— ${territory.enemyReward} é‡‘å¸` : 'è¯·é‡æ–°è°ƒæ•´æˆ˜æœ¯ã€‚'}</p>
                    <button class="mp-button ${isWin ? 'primary' : 'secondary'}" onclick="closeBattleResult(${isWin})">
                        ${isWin ? 'å‰å¾€å»ºè®¾é¢†åœ°' : 'è¿”å›åœ°å›¾'}
                    </button>
                </div>
            `;
        }

        function endBattle() {
            clearInterval(gameState.battleInterval);
            showLevelSelection();
        }

        function closeBattleResult(isWin) {
            if (isWin) {
                const t = gameState.currentTerritory;
                t.purified = true;
                t.owner = 'ç©å®¶';
                gameState.gold += t.enemyReward;
                
                // è§£é”ä¸‹ä¸€å…³
                const nextId = t.id + 1;
                if (!gameState.unlockedLevels.includes(nextId) && nextId <= 5) {
                    gameState.unlockedLevels.push(nextId);
                }
                updateStats();
                showDefenseOptions(t); // èƒœåˆ©åè·³è½¬åˆ°ç®¡ç†é¡µ
            } else {
                showLevelSelection();
            }
            renderWorldMap();
        }

        function returnToMap() {
            gameState.currentTerritory = null;
            showLevelSelection();
        }

        // --- æ‚é¡¹ ---
        function updateStats() {
            document.getElementById('gold').innerText = Math.floor(gameState.gold);
            const count = gameState.territories.filter(t => t.purified).length;
            document.getElementById('completed-count').innerText = count + '/5';
        }

        function updateTerritoryStats() { updateStats(); } // å…¼å®¹æ—§è°ƒç”¨

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            updateStats();
            showPhase('main-menu');
            
            // èµ„æºäº§å‡ºå¾ªç¯
            setInterval(() => {
                let income = 0;
                gameState.territories.forEach(t => {
                    if (t.purified) income += t.resources;
                });
                if (income > 0) {
                    gameState.gold += income / 60; // æ¯ç§’äº§å‡º
                    updateStats();
                }
            }, 1000);
        });
        
        // ç¤¾äº¤ç›¸å…³å­˜æ ¹
        function selectFaction(f) { gameState.faction = f; document.getElementById('faction-display').innerText = f==='knight'?'ğŸ›¡ï¸ éª‘å£«':'ğŸ‘¹ å“¥å¸ƒæ—'; }
        function initSocial() { /* ç®€å•å®ç° */ }
        function helpFriend() { alert('å·²å‘é€æ´åŠ©ï¼'); }
        function betrayFriend() { alert('èƒŒåˆºæˆåŠŸï¼è·å¾—é‡‘å¸ã€‚'); gameState.gold += 100; updateStats(); }
    </script>
</body>
</html>