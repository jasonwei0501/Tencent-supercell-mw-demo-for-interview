<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çš‡å®¤æˆ˜äº‰ï¼šå¤±è½ç‹å›½</title>
    <link rel="stylesheet" href="https://unpkg.com/tdesign-vue-next/dist/tdesign.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .stat-item {
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .main-menu {
            text-align: center;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .menu-title {
            color: white;
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .menu-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 18px;
            margin-bottom: 30px;
        }

        .menu-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .menu-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .phase-container {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .phase-container.active {
            display: block;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* æˆ˜æ–—å‡†å¤‡é˜¶æ®µæ ·å¼ */
        .preparation-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card-selection {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
        }

        .selected-cards {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .card-item {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            color: #1f2937;
            font-size: 12px;
        }

        .card-item:hover {
            background: #e5e7eb;
            border-color: #3b82f6;
            transform: scale(1.05);
        }

        .card-item.selected {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
            color: #1e40af;
        }

        .battle-grid {
            display: grid;
            grid-template-columns: repeat(6, 50px);
            grid-template-rows: repeat(6, 50px);
            gap: 2px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin: 0 auto;
            width: fit-content;
        }

        .grid-cell {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .grid-cell:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .grid-cell.occupied {
            background: rgba(0, 82, 217, 0.15);
            border-color: rgba(0, 82, 217, 0.4);
        }

        /* ç§¯æœ¨åµŒå…¥çš„å¿«æ„ŸåŠ¨ç”» */
        @keyframes snap-in {
            0% { transform: scale(1.3) rotate(5deg); opacity: 0.6; }
            30% { transform: scale(0.9) rotate(-3deg); opacity: 0.8; }
            60% { transform: scale(1.1) rotate(1deg); opacity: 1; }
            80% { transform: scale(0.98) rotate(-0.5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .grid-cell.occupied .placed-card {
            animation: snap-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .placed-card {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .start-battle-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
        }

        .start-battle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        /* æˆ˜æ–—é˜¶æ®µæ ·å¼ */
        .battle-field {
            background: linear-gradient(to bottom, #22c55e, #16a34a);
            border-radius: 8px;
            height: 400px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
        }

        .battle-unit {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            transition: left 0.2s cubic-bezier(0.4, 0, 0.2, 1), top 0.2s cubic-bezier(0.4, 0, 0.2, 1), transform 0.15s ease-out;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            animation: breathing 2.5s ease-in-out infinite;
            font-size: 20px;
            line-height: 24px;
            text-align: center;
            pointer-events: none;
            user-select: none;
        }

        .battle-unit.player {
            filter: drop-shadow(0 0 2px rgba(0, 82, 217, 0.8));
            background: rgba(0, 123, 255, 0.1);
        }

        .battle-unit.enemy {
            filter: drop-shadow(0 0 2px rgba(220, 38, 38, 0.8));
            background: rgba(255, 123, 123, 0.1);
            transform: scaleX(-1);
        }

        @keyframes breathing {
            0%, 100% { transform: scale(1) translateY(0px); border-radius: 50%; }
            25% { transform: scale(1.05) translateY(-1px); border-radius: 48%; }
            50% { transform: scale(1.1) translateY(-2px); border-radius: 45%; }
            75% { transform: scale(1.05) translateY(-1px); border-radius: 48%; }
        }

        .battle-unit.attacking {
            animation: unitAttack 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes unitAttack {
            0% { transform: scale(1) translateY(0px) rotate(0deg); border-radius: 50%; }
            20% { transform: scale(0.8, 1.2) translateY(3px) rotate(-3deg); border-radius: 40%; }
            40% { transform: scale(1.4, 0.7) translateY(-5px) rotate(5deg); border-radius: 60%; }
            60% { transform: scale(1.2, 0.9) translateY(-2px) rotate(-1deg); border-radius: 50%; }
            80% { transform: scale(0.95, 1.05) translateY(1px) rotate(1deg); border-radius: 48%; }
            100% { transform: scale(1) translateY(0px) rotate(0deg); border-radius: 50%; }
        }

        .battle-unit.hit {
            animation: unitHit 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes unitHit {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            15% { transform: scale(1.3, 0.8) rotate(15deg); opacity: 0.9; }
            30% { transform: scale(0.7, 1.4) rotate(-20deg); opacity: 0.7; }
            45% { transform: scale(1.2, 0.6) rotate(10deg); opacity: 0.5; }
            60% { transform: scale(0.8, 1.2) rotate(-5deg); opacity: 0.3; }
            75% { transform: scale(1.1, 0.9) rotate(2deg); opacity: 0.1; }
            100% { transform: scale(0) rotate(0deg); opacity: 0; }
        }

        .explosion {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle, #fff 0%, #ff6b6b 20%, #ff4757 60%, transparent 100%);
            animation: explode 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
        }

        @keyframes explode {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            25% { transform: scale(0.8) rotate(90deg); opacity: 1; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 0.8; }
            75% { transform: scale(1.5) rotate(270deg); opacity: 0.4; }
            100% { transform: scale(2) rotate(360deg); opacity: 0; }
        }

        .damage-number {
            position: absolute;
            color: #ff4757;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            animation: damageFloat 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            pointer-events: none;
            z-index: 101;
        }

        @keyframes damageFloat {
            0% { transform: translateY(0px) scale(0.5); opacity: 0; }
            20% { transform: translateY(-8px) scale(1.2); opacity: 1; }
            50% { transform: translateY(-20px) scale(1); opacity: 1; }
            100% { transform: translateY(-45px) scale(0.8); opacity: 0; }
        }

        .battle-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            color: white;
            flex-wrap: wrap;
            gap: 10px;
        }

        .speed-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .speed-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .speed-btn.active {
            background: rgba(59, 130, 246, 0.6);
            border-color: #3b82f6;
        }

        .speed-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* å¾®ä¿¡å°ç¨‹åºé£æ ¼ */
        .miniprogram-container {
            background: #f5f5f5;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }

        .mp-header {
            background: linear-gradient(135deg, #07c160 0%, #06ae56 100%);
            color: white;
            padding: 20px 15px 15px;
            position: relative;
        }

        .mp-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background: rgba(0, 0, 0, 0.05);
        }

        .mp-title {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 8px;
        }

        .mp-subtitle {
            font-size: 14px;
            opacity: 0.9;
            text-align: center;
        }

        .mp-content {
            padding: 15px;
        }

        .mp-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mp-button {
            background: #07c160;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            text-align: center;
        }

        .mp-button:hover {
            background: #06ae56;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(7, 193, 96, 0.3);
        }

        .mp-button:active {
            transform: translateY(0);
        }

        .mp-button.secondary {
            background: #f2f2f2;
            color: #333;
        }

        .mp-button.secondary:hover {
            background: #e8e8e8;
        }

        .mp-button.danger {
            background: #ff4757;
        }

        .mp-button.danger:hover {
            background: #ff3838;
        }

        .mp-grid {
            display: grid;
            gap: 12px;
        }

        .mp-grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .mp-grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .mp-stats {
            display: flex;
            justify-content: space-between;
            background: white;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .mp-stat-item {
            text-align: center;
        }

        .mp-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #059669;
        }

        .mp-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .mp-battle-field {
            background: linear-gradient(to bottom, #d4f4dd 0%, #a8e6b8 100%);
            border-radius: 12px;
            height: 300px;
            position: relative;
            overflow: hidden;
            margin: 15px 0;
            border: 2px solid #c3e6d0;
        }

        .mp-menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .mp-menu-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .mp-menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .mp-menu-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .mp-menu-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .mp-menu-desc {
            font-size: 12px;
            color: #6b7280;
        }

        .mp-friend-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .mp-friend-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mp-friend-avatar {
            font-size: 24px;
        }

        .mp-friend-details {
            font-size: 14px;
        }

        .mp-friend-name {
            font-weight: 600;
            color: #333;
        }

        .mp-friend-faction {
            font-size: 12px;
            color: #999;
        }

        .mp-action-buttons {
            display: flex;
            gap: 8px;
        }

        .mp-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mp-territory {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .mp-territory-info {
            flex: 1;
        }

        .mp-territory-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .mp-territory-status {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .mp-territory-resource {
            font-size: 12px;
            color: #07c160;
            font-weight: 500;
        }

        .mp-world-map {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e8e8e8;
            position: relative;
            height: 320px;
            overflow: hidden;
        }

        .mp-territory-map-item {
            position: absolute;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 11px;
            width: 70px;
            height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .mp-territory-map-item.purified {
            background: linear-gradient(135deg, #d4f4dd 0%, #a8e6b8 100%);
            border-color: #07c160;
        }

        .mp-territory-map-item.enemy {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-color: #ff4757;
        }

        .mp-territory-map-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .mp-tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            padding: 8px 0;
            z-index: 1000;
        }

        .mp-tab-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #999;
            font-size: 12px;
        }

        .mp-tab-item.active {
            color: #07c160;
        }

        .mp-tab-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .mp-page {
            padding-bottom: 60px; /* ä¸ºåº•éƒ¨å¯¼èˆªç•™ç©ºé—´ */
            display: none; /* é»˜è®¤éšè—æ‰€æœ‰é¡µé¢ */
        }

        .mp-page.active {
            display: block; /* åªæ˜¾ç¤ºæ¿€æ´»çš„é¡µé¢ */
        }

        .battle-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .battle-log-item {
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            margin-bottom: 5px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        /* ç¤¾äº¤ç³»ç»Ÿæ ·å¼ */
        .social-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            color: white;
        }

        .faction-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .faction-btn {
            padding: 10px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .faction-btn.active {
            background: rgba(59, 130, 246, 0.5);
            border-color: #3b82f6;
        }

        .faction-btn.goblin.active {
            background: rgba(239, 68, 68, 0.5);
            border-color: #ef4444;
        }

        .friends-list {
            margin-top: 20px;
        }

        .friend-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .help-btn {
            background: #22c55e;
            color: white;
        }

        .betray-btn {
            background: #ef4444;
            color: white;
        }

        .social-feed {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .feed-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        /* é¢†åœŸç³»ç»Ÿæ ·å¼ */
        .territory-map {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .world-map {
            background: linear-gradient(135deg, #374151, #1f2937);
            border-radius: 8px;
            height: 400px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
        }

        .territory {
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            text-align: center;
            padding: 5px;
        }

        .territory:hover {
            transform: scale(1.1);
        }

        .territory.purified {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-color: #22c55e;
        }

        .territory.enemy {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: #ef4444;
        }

        .territory-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
        }

        .territory-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conquer-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .defense-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .preparation-container {
                grid-template-columns: 1fr;
            }
            
            .menu-title {
                font-size: 28px;
            }
            
            .battle-grid {
                grid-template-columns: repeat(6, 40px);
                grid-template-rows: repeat(6, 40px);
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        /* å…³å¡å¼•å¯¼å°çº¢ç‚¹åŠ¨ç”» */
        @keyframes pulse-dot {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.3);
                opacity: 0.7;
            }
        }

        /* èƒœåˆ©å¼¹è·³åŠ¨ç”» */
        @keyframes bounce {
            0%, 100% {
                transform: translateY(0) scale(1);
            }
            25% {
                transform: translateY(-20px) scale(1.1);
            }
            50% {
                transform: translateY(0) scale(1);
            }
            75% {
                transform: translateY(-10px) scale(1.05);
            }
        }

        /* å…³å¡è§£é”è¿çº¿åŠ¨ç”» */
        .unlock-connection {
            position: absolute;
            background: linear-gradient(90deg, transparent, #ef4444, transparent);
            height: 2px;
            transform-origin: left center;
            animation: connection-pulse 2s infinite;
            pointer-events: none;
            z-index: 5;
        }

        @keyframes connection-pulse {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 0.8;
            }
        }

        /* å…³å¡è§£é”ç‰¹æ•ˆ */
        .level-unlock-effect {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 3px solid #fbbf24;
            border-radius: 50%;
            pointer-events: none;
            animation: unlock-ring 1.5s ease-out forwards;
            z-index: 20;
        }

        /* å¤±è´¥ç•Œé¢æ ·å¼ */
        .failure-interface {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #fecaca;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.1);
        }

        .failure-title {
            font-size: 24px;
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 15px;
        }

        .failure-description {
            font-size: 16px;
            color: #7f1d1d;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .failure-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .retry-button {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 180px;
        }

        .retry-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .back-to-menu-button {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 180px;
        }

        .back-to-menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.3);
        }

        @keyframes unlock-ring {
            0% {
                transform: scale(0.5);
                opacity: 0;
                border-color: #ef4444;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
                border-color: #f59e0b;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
                border-color: #10b981;
            }
        }
    </style>
</head>
<body>
    <div class="miniprogram-container">
        <div class="mp-header">
            <div class="mp-title">çš‡å®¤æˆ˜äº‰ï¼šå¤±è½ç‹å›½</div>
            <div class="mp-subtitle">èƒŒåŒ…æ•´ç† | ç™¾äººåŒå± | ç¤¾äº¤æ•´æ´» | é¢†åœŸå¾æœ</div>
        </div>

        <div class="mp-content">

        <div id="main-menu" class="mp-page active">
            <div class="mp-stats">
                <div class="mp-stat-item">
                    <div class="mp-stat-value">ğŸ’° <span id="gold">500</span></div>
                    <div class="mp-stat-label">é‡‘å¸</div>
                </div>
                <div class="mp-stat-item">
                    <div class="mp-stat-value" id="faction-display">ğŸ›¡ï¸ éª‘å£«</div>
                    <div class="mp-stat-label">é˜µè¥</div>
                </div>
                <div class="mp-stat-item">
                    <div class="mp-stat-value">âš”ï¸ 0</div>
                    <div class="mp-stat-label">èƒœåˆ©</div>
                </div>
            </div>

            <div class="mp-menu-grid">
                <div class="mp-menu-item" onclick="showPhase('territory')">
                    <div class="mp-menu-icon">ğŸ—ºï¸</div>
                    <div class="mp-menu-title">å…³å¡æŒ‘æˆ˜</div>
                    <div class="mp-menu-desc">æ”¶å¤å¤±è½çš„ç‹å›½</div>
                </div>
                <div class="mp-menu-item" onclick="showPhase('social')">
                    <div class="mp-menu-icon">ğŸ‘¥</div>
                    <div class="mp-menu-title">ç¤¾äº¤ç³»ç»Ÿ</div>
                    <div class="mp-menu-desc">èƒŒå›ä¸è”ç›Ÿ</div>
                </div>
                <div class="mp-menu-item" onclick="showPhase('about')">
                    <div class="mp-menu-icon">ğŸ“–</div>
                    <div class="mp-menu-title">æ¸¸æˆä»‹ç»</div>
                    <div class="mp-menu-desc">ç©æ³•è¯´æ˜</div>
                </div>
            </div>

            <div class="mp-card" style="margin-top: 20px;">
                <h3 style="color: #1f2937; margin-bottom: 12px; font-size: 16px;">ğŸ® æ¸¸æˆç‰¹è‰²</h3>
                <div style="font-size: 14px; line-height: 1.6; color: #4b5563;">
                    <div style="margin-bottom: 8px;">ğŸ§© <strong style="color: #1f2937;">èƒŒåŒ…æ•´ç†å¤‡æˆ˜</strong> - åŠ¨è„‘ä¸åŠ¨æ‰‹çš„ç­–ç•¥ä¹è¶£</div>
                    <div style="margin-bottom: 8px;">âš”ï¸ <strong style="color: #1f2937;">ç™¾äººåŒå±æˆ˜æ–—</strong> - å²è¯—çº§æˆ˜åœºä½“éªŒ</div>
                    <div style="margin-bottom: 8px;">ğŸ‘¥ <strong style="color: #1f2937;">ç¤¾äº¤èƒŒå›æœºåˆ¶</strong> - å¾®ä¿¡ç¾¤ç‹¼äººæ€</div>
                    <div><strong style="color: #1f2937;">ğŸ—ºï¸ ç®±åº­æ¢ç´¢</strong> - æ”¶å¤å¤±è½çš„ç‹å›½</div>
                </div>
            </div>
        </div>

        <div id="social-phase" class="mp-page">
            <div class="mp-card">
                <button class="mp-button secondary" onclick="showPhase('main-menu')">â† è¿”å›</button>
            </div>

            <div class="mp-card">
                <h2 style="text-align: center; margin-bottom: 20px; color: #333; font-size: 18px;">ç¤¾äº¤ç³»ç»Ÿ</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="mp-button" id="faction-knight" onclick="selectFaction('knight')" style="flex: 1;">
                        ğŸ›¡ï¸ çš‡å®¶éª‘å£«
                    </button>
                    <button class="mp-button secondary" id="faction-goblin" onclick="selectFaction('goblin')" style="flex: 1;">
                        ğŸ‘¹ å“¥å¸ƒæ—
                    </button>
                </div>
                
                <div id="faction-abilities">
                    </div>
            </div>
            
            <div class="mp-card">
                <h3 style="color: #333; margin-bottom: 12px; font-size: 16px;">å¥½å‹åˆ—è¡¨</h3>
                <div id="friends-container">
                    </div>
            </div>
            
            <div class="mp-card">
                <h3 style="color: #333; margin-bottom: 12px; font-size: 16px;">ç¤¾äº¤åŠ¨æ€</h3>
                <div id="social-feed-content" style="max-height: 250px; overflow-y: auto;">
                    <div style="padding: 8px; background: #f8f8f8; border-radius: 6px; font-size: 14px; color: #666;">
                        æ¬¢è¿æ¥åˆ°ç¤¾äº¤ç³»ç»Ÿï¼é€‰æ‹©é˜µè¥å¼€å§‹ä½ çš„ç¤¾äº¤ä¹‹æ—…ã€‚
                    </div>
                </div>
            </div>
        </div>

        <div id="territory-phase" class="mp-page">
            <div id="level-selection-view">
                <div class="mp-card">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #333; font-size: 18px;">ğŸ—ºï¸ å…³å¡æŒ‘æˆ˜</h2>
                    
                    <div class="mp-stats">
                        <div class="mp-stat-item">
                            <div class="mp-stat-value">âš”ï¸ <span id="current-level-display">1</span></div>
                            <div class="mp-stat-label">å½“å‰å…³å¡</div>
                        </div>
                        <div class="mp-stat-item">
                            <div class="mp-stat-value">ğŸ† <span id="completed-count">0</span>/5</div>
                            <div class="mp-stat-label">å·²å®Œæˆ</div>
                        </div>
                        <div class="mp-stat-item">
                            <div class="mp-stat-value">ğŸ’° <span id="total-rewards">0</span></div>
                            <div class="mp-stat-label">æ€»å¥–åŠ±</div>
                        </div>
                        <div class="mp-stat-item">
                            <div class="mp-stat-value">â±ï¸ <span id="income-rate">0</span>/æ—¶</div>
                            <div class="mp-stat-label">æŒç»­æ”¶ç›Š</div>
                        </div>
                    </div>
                    
                    <div class="mp-world-map" id="world-map">
                        </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #f8f8f8; border-radius: 8px;">
                        <h4 style="color: #333; font-size: 14px; margin-bottom: 8px;">ğŸ¯ æ“ä½œè¯´æ˜</h4>
                        <p style="color: #666; font-size: 12px; line-height: 1.5;">
                            ç‚¹å‡»åœ°å›¾ä¸Š<span style="color: #07c160;">å·²è§£é”</span>çš„å…³å¡å¼€å§‹æŒ‘æˆ˜ï¼Œå®Œæˆåè§£é”ä¸‹ä¸€å…³ã€‚
                        </p>
                    </div>
                </div>
            </div>

            <div id="battle-prep-view" style="display: none;">
                <div class="mp-card">
                    <button class="mp-button secondary" onclick="showLevelSelection()">â† è¿”å›å…³å¡é€‰æ‹©</button>
                    <div id="selected-level-info" style="padding: 15px; background: rgba(31, 41, 55, 0.1); border-radius: 8px; margin: 15px 0;">
                        </div>
                </div>

                <div class="mp-card">
                    <h3 style="color: #333; margin-bottom: 15px; font-size: 16px;">é€‰æ‹©å¡ç‰Œ (è´¹ç”¨é™åˆ¶: 10)</h3>
                    <div style="color: #07c160; margin-bottom: 10px; font-weight: 500;">
                        å½“å‰è´¹ç”¨: <span id="current-cost">0</span>/10
                    </div>
                    <div class="card-grid" id="card-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        </div>
                </div>
                
                <div class="mp-card">
                    <h3 style="color: #333; margin-bottom: 15px; font-size: 16px;">æˆ˜åœºå¸ƒç½®</h3>
                    <div class="battle-grid" id="battle-grid" style="margin: 0 auto; width: fit-content;">
                        </div>
                    <button class="mp-button" onclick="startBattle()" style="margin: 15px auto 0; display: block;">å¼€å§‹æˆ˜æ–—</button>
                </div>
            </div>
        </div>

        <div id="about-phase" class="mp-page">
            <div class="mp-card">
                <button class="mp-button secondary" onclick="showPhase('main-menu')">â† è¿”å›</button>
            </div>

            <div class="mp-card">
                <h2 style="text-align: center; margin-bottom: 20px; color: #1f2937; font-size: 18px;">æ¸¸æˆç©æ³•è¯´æ˜</h2>
                
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #059669; font-size: 16px; margin-bottom: 8px;">ğŸ§© èƒŒåŒ…æ•´ç†å¤‡æˆ˜</h3>
                    <p style="color: #4b5563; font-size: 14px; line-height: 1.5;">
                        å°†ä¼ ç»Ÿå¡ç‰Œæ¸¸æˆçš„æ—¶é—´å‹åŠ›è½¬åŒ–ä¸ºç©ºé—´æ‹¼å›¾æŒ‘æˆ˜ã€‚é€‰æ‹©å¡ç‰Œï¼Œåˆç†å¸ƒç½®åœ¨æœ‰é™æ ¼å­ä¸­ï¼Œä½“éªŒæ•´ç†æ”¶çº³çš„ä¹è¶£ã€‚
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <h3 style="color: #059669; font-size: 16px; margin-bottom: 8px;">âš”ï¸ ç™¾äººåŒå±æˆ˜æ–—</h3>
                    <p style="color: #4b5563; font-size: 14px; line-height: 1.5;">
                        ä¸€å¼ å¡ç‰Œå®ä½“åŒ–ä¸ºæ•°åä¸ªå•ä½ï¼Œè‡ªåŠ¨è¿›è¡Œå®æ—¶æˆ˜æ–—ã€‚æ”¯æŒ1xã€2xã€4xå€é€Ÿè§‚çœ‹ï¼Œäº«å—å²è¯—çº§æˆ˜åœºä½“éªŒã€‚
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <h3 style="color: #059669; font-size: 16px; margin-bottom: 8px;">ğŸ‘¥ ç¤¾äº¤èƒŒå›æœºåˆ¶</h3>
                    <p style="color: #4b5563; font-size: 14px; line-height: 1.5;">
                        é€‰æ‹©çš‡å®¶éª‘å£«æˆ–å“¥å¸ƒæ—é˜µè¥ï¼Œä¸å¥½å‹äº’åŠ¨ã€‚å¯ä»¥é€‰æ‹©å¸®åŠ©å¥½å‹(æ¶ˆè€—é‡‘å¸)æˆ–èƒŒå›æ å¤º(è·å¾—é‡‘å¸)ï¼Œä½“éªŒå¾®ä¿¡ç¾¤ç‹¼äººæ€çš„åˆºæ¿€ã€‚
                    </p>
                </div>

                <div style="margin-bottom: 15px;">
                    <h3 style="color: #059669; font-size: 16px; margin-bottom: 8px;">ğŸ—ºï¸ é¢†åœŸå¾æœ</h3>
                    <p style="color: #4b5563; font-size: 14px; line-height: 1.5;">
                        æ”»å‡»è¢«å“¥å¸ƒæ—å é¢†çš„é¢†åœŸï¼ŒæˆåŠŸæ”¶å¤åè·å¾—æŒç»­èµ„æºäº§å‡ºã€‚å»ºç«‹é˜²å¾¡é˜µå‹ä¿æŠ¤ä½ çš„é¢†åœŸï¼Œé‡å»ºå¤±è½ç‹å›½ã€‚
                    </p>
                </div>
            </div>

            <div class="mp-card">
                <h3 style="color: #1f2937; font-size: 16px; margin-bottom: 10px;">ğŸ’¡ æ¸¸æˆç‰¹è‰²</h3>
                <div style="color: #4b5563; font-size: 14px; line-height: 1.6;">
                    <p>â€¢ <strong>é™ç»´æ‰“å‡»</strong>ï¼šé™ä½æ“ä½œé—¨æ§›ï¼Œä¿ç•™ç­–ç•¥å¿«æ„Ÿ</p>
                    <p>â€¢ <strong>ç¤¾äº¤å‡ç»´</strong>ï¼šä»æœºæ¢°äº’åŠ¨åˆ°æƒ…æ„Ÿé©±åŠ¨çš„ç—…æ¯’ä¼ æ’­</p>
                    <p>â€¢ <strong>æ²‰æµ¸ä½“éªŒ</strong>ï¼šç®±åº­è®¾è®¡çš„é«˜çº§æ„Ÿï¼Œæ”¶å¤æ²³å±±çš„æˆå°±æ„Ÿ</p>
                </div>
            </div>

            <div style="margin-top: 30px; text-align: center; opacity: 0.6; font-size: 12px; color: #6b7280;">
                Demo by é­æ˜è½© | 2026<br>
                Built with Passion & Code âœ¨
            </div>
        </div>

        <div class="mp-tab-bar">
            <div class="mp-tab-item active" onclick="showPhase('main-menu')">
                <div class="mp-tab-icon">ğŸ </div>
                <div>é¦–é¡µ</div>
            </div>
            <div class="mp-tab-item" onclick="showPhase('territory')">
                <div class="mp-tab-icon">ğŸ—ºï¸</div>
                <div>é¢†åœŸ</div>
            </div>
            <div class="mp-tab-item" onclick="showPhase('social')">
                <div class="mp-tab-icon">ğŸ‘¥</div>
                <div>ç¤¾äº¤</div>
            </div>
            <div class="mp-tab-item" onclick="showPhase('about')">
                <div class="mp-tab-icon">ğŸ“–</div>
                <div>ç©æ³•</div>
            </div>
        </div>
        </div> </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            gold: 500,
            faction: 'knight',
            selectedCards: [],
            placedCards: [],
            battleUnits: [],
            battleTime: 0,
            battleInterval: null,
            resourceInterval: null,
            battleSpeed: 1, // 1x, 2x, 4x speed
            currentLevel: 1,
            currentTerritory: null,
            lastFailedTerritory: null,
            unlockedLevels: [1], // å·²è§£é”çš„å…³å¡
            territories: [
                { 
                    id: 1, 
                    name: 'å¤±è½çš„ç¥æ®¿', 
                    purified: false, 
                    owner: 'å“¥å¸ƒæ—', 
                    resources: 10, 
                    x: 50, 
                    y: 50,
                    level: 1,
                    enemyCards: [
                        {id: 'enemy_goblin_1', elixirCost: 2, damage: 100, hp: 200, icon: 'ğŸ‘º'},
                        {id: 'enemy_archer_1', elixirCost: 3, damage: 150, hp: 300, icon: 'ğŸ¹'}
                    ],
                    enemyReward: 50
                },
                { 
                    id: 2, 
                    name: 'ç ´ç¢çš„è¿œå¾æ¡¥', 
                    purified: false, 
                    owner: 'å“¥å¸ƒæ—', 
                    resources: 15, 
                    x: 200, 
                    y: 100,
                    level: 2,
                    enemyCards: [
                        {id: 'enemy_goblin_2', elixirCost: 3, damage: 120, hp: 250, icon: 'ğŸ‘º'},
                        {id: 'enemy_archer_2', elixirCost: 3, damage: 160, hp: 320, icon: 'ğŸ¹'},
                        {id: 'enemy_knight_1', elixirCost: 4, damage: 200, hp: 400, icon: 'ğŸ›¡ï¸'}
                    ],
                    enemyReward: 80
                },
                { 
                    id: 3, 
                    name: 'æ·±æ¸Šçš„å“€åšæ´ç©´', 
                    purified: false, 
                    owner: 'å“¥å¸ƒæ—', 
                    resources: 20, 
                    x: 350, 
                    y: 80,
                    level: 3,
                    enemyCards: [
                        {id: 'enemy_goblin_3', elixirCost: 3, damage: 140, hp: 280, icon: 'ğŸ‘º'},
                        {id: 'enemy_archer_3', elixirCost: 4, damage: 180, hp: 350, icon: 'ğŸ¹'},
                        {id: 'enemy_knight_2', elixirCost: 4, damage: 220, hp: 420, icon: 'ğŸ›¡ï¸'}
                    ],
                    enemyReward: 120
                },
                { 
                    id: 4, 
                    name: 'å‡‹é›¶çš„çš‡å®¶åŸå ¡', 
                    purified: false, 
                    owner: 'å“¥å¸ƒæ—', 
                    resources: 25, 
                    x: 150, 
                    y: 250,
                    level: 4,
                    enemyCards: [
                        {id: 'enemy_goblin_4', elixirCost: 4, damage: 160, hp: 300, icon: 'ğŸ‘º'},
                        {id: 'enemy_archer_4', elixirCost: 4, damage: 200, hp: 380, icon: 'ğŸ¹'},
                        {id: 'enemy_knight_3', elixirCost: 5, damage: 250, hp: 450, icon: 'ğŸ›¡ï¸'}
                    ],
                    enemyReward: 160
                },
                { 
                    id: 5, 
                    name: 'æ°¸æ’é¾™ä¹‹å¢“ç©´', 
                    purified: false, 
                    owner: 'å“¥å¸ƒæ—', 
                    resources: 30, 
                    x: 300, 
                    y: 220,
                    level: 5,
                    enemyCards: [
                        {id: 'enemy_goblin_5', elixirCost: 5, damage: 200, hp: 350, icon: 'ğŸ‘º'},
                        {id: 'enemy_archer_5', elixirCost: 5, damage: 240, hp: 420, icon: 'ğŸ¹'},
                        {id: 'enemy_knight_4', elixirCost: 5, damage: 280, hp: 500, icon: 'ğŸ›¡ï¸'},
                        {id: 'enemy_mage_1', elixirCost: 6, damage: 300, hp: 400, icon: 'ğŸ§™'}
                    ],
                    enemyReward: 200
                }
            ],
            friends: [
                { id: 1, name: 'å¼ ä¸‰', faction: 'knight', avatar: 'ğŸ‘¤' },
                { id: 2, name: 'æå››', faction: 'goblin', avatar: 'ğŸ‘¥' },
                { id: 3, name: 'ç‹äº”', faction: 'knight', avatar: 'ğŸ‘¨' }
            ],
            socialFeed: ['æ¬¢è¿æ¥åˆ°ç¤¾äº¤ç³»ç»Ÿï¼']
        };

        // å¡ç‰Œæ•°æ®ï¼ˆæ·»åŠ å½¢çŠ¶ä¿¡æ¯å’Œemojiå›¾æ ‡ï¼‰
        const cards = [
            { id: 1, name: 'å·¨äºº', icon: 'ğŸ§Ÿâ€â™‚ï¸', cost: 5, damage: 50, health: 200, color: '#ef4444', shape: [[1,1],[1,1]], width: 2, height: 2 },
            { id: 2, name: 'å¼“ç®­æ‰‹', icon: 'ğŸ¹', cost: 3, damage: 30, health: 80, color: '#22c55e', shape: [[1]], width: 1, height: 1 },
            { id: 3, name: 'éª‘å£«', icon: 'ğŸ›¡ï¸', cost: 3, damage: 40, health: 120, color: '#3b82f6', shape: [[1,0],[1,1]], width: 2, height: 2 },
            { id: 4, name: 'éª·é«…å…µ', icon: 'ğŸ’€', cost: 1, damage: 20, health: 40, color: '#6b7280', shape: [[1]], width: 1, height: 1 },
            { id: 5, name: 'æ³•å¸ˆ', icon: 'ğŸ§™â€â™‚ï¸', cost: 4, damage: 60, health: 100, color: '#8b5cf6', shape: [[1,1]], width: 2, height: 1 },
            { id: 6, name: 'å…¬ä¸»', icon: 'ğŸ‘¸', cost: 4, damage: 60, health: 60, color: '#ec4899', shape: [[1]], width: 1, height: 1 }
        ];

        // æ˜¾ç¤ºä¸åŒé˜¶æ®µ
        function showPhase(phase) {
            // éšè—æ‰€æœ‰é˜¶æ®µ
            document.querySelectorAll('.mp-page').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            
            // æ›´æ–°åº•éƒ¨å¯¼èˆªçŠ¶æ€
            document.querySelectorAll('.mp-tab-item').forEach(el => {
                el.classList.remove('active');
            });
            
            // æ˜¾ç¤ºæŒ‡å®šé˜¶æ®µ
            const phaseId = phase === 'main-menu' ? 'main-menu' : phase + '-phase';
            const targetPhase = document.getElementById(phaseId);
            if (targetPhase) {
                targetPhase.style.display = 'block';
                targetPhase.classList.add('active');
            }
            
            // æ¿€æ´»å¯¹åº”çš„åº•éƒ¨å¯¼èˆª
            const tabIndex = {
                'main-menu': 0,
                'social': 1,
                'territory': 2,
                'about': 3
            };
            if (tabIndex[phase] !== undefined) {
                const tabItems = document.querySelectorAll('.mp-tab-item');
                if (tabItems[tabIndex[phase]]) {
                    tabItems[tabIndex[phase]].classList.add('active');
                }
            }
            
            // åˆå§‹åŒ–å¯¹åº”é˜¶æ®µ
            if (phase === 'preparation') {
                initPreparation();
            } else if (phase === 'social') {
                initSocial();
            } else if (phase === 'territory') {
                initTerritory();
            }
        }

        // è®¾ç½®æˆ˜æ–—é€Ÿåº¦
        function setBattleSpeed(speed) {
            gameState.battleSpeed = speed;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.speed-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // å¦‚æœæˆ˜æ–—æ­£åœ¨è¿›è¡Œï¼Œé‡æ–°å¯åŠ¨æˆ˜æ–—å¾ªç¯
            if (gameState.battleInterval) {
                clearInterval(gameState.battleInterval);
                startBattleSimulation();
            }
        }

        // åˆå§‹åŒ–æˆ˜æ–—å‡†å¤‡é˜¶æ®µ
        function initPreparation() {
            const cardGrid = document.getElementById('card-grid');
            const battleGrid = document.getElementById('battle-grid');
            
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼ˆä¿®å¤innerHTMLä¸ºnullé”™è¯¯ï¼‰
            if (!cardGrid || !battleGrid) {
                console.error('å‡†å¤‡é˜¶æ®µå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // ç”Ÿæˆå¡ç‰Œï¼ˆæ˜¾ç¤ºå½¢çŠ¶é¢„è§ˆï¼‰
            cardGrid.innerHTML = '';
            cards.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card-item';
                
                // ç”Ÿæˆå½¢çŠ¶é¢„è§ˆ
                let shapePreview = '';
                for (let i = 0; i < card.shape.length; i++) {
                    let row = '<div style="display: flex;">';
                    for (let j = 0; j < card.shape[i].length; j++) {
                        // ä¿®æ­£ï¼šå°†è¾¹æ¡†é¢œè‰²æ”¹ä¸ºé»‘è‰²åŠé€æ˜ï¼Œä»¥é€‚åº”æµ…è‰²èƒŒæ™¯
                        row += `<div style="width: 8px; height: 8px; margin: 1px; background: ${card.shape[i][j] ? card.color : 'transparent'}; border: 1px solid rgba(0,0,0,0.2);"></div>`;
                    }
                    row += '</div>';
                    shapePreview += row;
                }
                
                cardEl.innerHTML = `
                    <div style="background: ${card.color}; width: 30px; height: 30px; margin: 0 auto 5px; border-radius: 4px;"></div>
                    <div style="font-weight: bold;">${card.name}</div>
                    <div>è´¹ç”¨: ${card.cost}</div>
                    <div>ä¼¤å®³: ${card.damage}</div>
                    <div style="margin-top: 5px; font-size: 10px; color: #999;">
                        ${card.width}x${card.height}æ ¼å­
                    </div>
                    <div style="margin: 5px auto;">${shapePreview}</div>
                `;
                cardEl.onclick = () => selectCard(card);
                cardEl.id = `card-${card.id}`;
                cardGrid.appendChild(cardEl);
            });
            
            // ç”Ÿæˆæˆ˜åœºæ ¼å­
            battleGrid.innerHTML = '';
            for (let i = 0; i < 36; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.onclick = () => placeCard(i);
                cell.id = `cell-${i}`;
                battleGrid.appendChild(cell);
            }
            
            // é‡ç½®çŠ¶æ€
            gameState.selectedCards = [];
            gameState.placedCards = [];
            updateCost();
        }

        // é€‰æ‹©å¡ç‰Œï¼ˆä¿®å¤ç‰ˆï¼šåŒ…å«è´¹ç”¨é™åˆ¶æ£€æŸ¥ï¼‰
        function selectCard(card) {
            // 1. å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰å·²ç»é€‰ä¸­çš„å¡ï¼Œåˆ™å–æ¶ˆé€‰ä¸­ï¼ˆæ”¾ä¸‹ï¼‰
            if (gameState.selectedCards.length > 0 && gameState.selectedCards[0].id === card.id) {
                gameState.selectedCards = [];
                document.getElementById(`card-${card.id}`).classList.remove('selected');
                updateCost();
                return;
            }

            // 2. è®¡ç®—å½“å‰æ£‹ç›˜å·²å ç”¨çš„è´¹ç”¨
            const currentBoardCost = gameState.placedCards.reduce((sum, p) => sum + p.card.cost, 0);
            
            // 3. æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨æ£‹ç›˜ä¸Šï¼ˆå¦‚æœæ˜¯ç§»åŠ¨æ“ä½œï¼Œä¸å¢åŠ è´¹ç”¨ï¼›å¦‚æœæ˜¯æ–°ä¸Šåœºï¼Œè¦æ£€æŸ¥è´¹ç”¨ï¼‰
            const isAlreadyOnBoard = gameState.placedCards.some(p => p.card.id === card.id);
            const costToAdd = isAlreadyOnBoard ? 0 : card.cost;

            // 4. æ ¸å¿ƒé™åˆ¶ï¼šå¦‚æœè¶…å‡º 10 è´¹ï¼Œç¦æ­¢é€‰ä¸­
            if (currentBoardCost + costToAdd > 10) {
                // ä½¿ç”¨ TDesign é£æ ¼çš„è½»æç¤ºæˆ–åŸç”Ÿ Alert
                const remaining = 10 - currentBoardCost;
                alert(`è´¹ç”¨ä¸è¶³ï¼å½“å‰å‰©ä½™ ${remaining} è´¹ï¼Œæ­¤å¡ç‰Œéœ€è¦ ${card.cost} è´¹ã€‚`);
                return;
            }

            // 5. äº’æ–¥é€‰æ‹©ï¼šæ¸…é™¤å…¶ä»–æ‰€æœ‰å¡ç‰Œçš„é€‰ä¸­çŠ¶æ€
            gameState.selectedCards = [];
            document.querySelectorAll('.card-item').forEach(el => el.classList.remove('selected'));

            // 6. é€‰ä¸­å½“å‰å¡ç‰Œ
            gameState.selectedCards.push(card);
            document.getElementById(`card-${card.id}`).classList.add('selected');
            
            updateCost();
        }

       // æ”¾ç½®å¡ç‰Œï¼ˆä¿®å¤ç‰ˆï¼šæ”¾ç½®åè‡ªåŠ¨å–æ¶ˆé€‰ä¸­ï¼‰
        function placeCard(cellIndex) {
            // 1. å¦‚æœæ²¡é€‰å¡ç‰Œï¼ŒæŠ¥é”™
            if (gameState.selectedCards.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©å¡ç‰Œï¼');
                return;
            }
            
            const card = gameState.selectedCards[0];
            const row = Math.floor(cellIndex / 6);
            const col = cellIndex % 6;
            
            // 2. æ£€æŸ¥ä½ç½®æ˜¯å¦åˆæ³•
            if (canPlaceCard(card, row, col)) {
                // ç§»é™¤æ—§çš„ä½ç½®ï¼ˆå®ç°â€œç§»åŠ¨â€æ•ˆæœè€Œä¸æ˜¯â€œå¤åˆ¶â€ï¼‰
                removePlacedCard(card.id);
                
                // åœ¨æ–°ä½ç½®æ”¾ç½®
                placeCardOnGrid(card, row, col);

                // --- æ ¸å¿ƒä¿®å¤å¼€å§‹ ---
                // 3. æ”¾ç½®æˆåŠŸåï¼Œç«‹å³å–æ¶ˆé€‰ä¸­çŠ¶æ€
                gameState.selectedCards = []; // æ¸…ç©ºæ•°æ®é€‰ä¸­
                
                // ç§»é™¤æ‰€æœ‰å¡ç‰Œçš„è§†è§‰é«˜äº®
                document.querySelectorAll('.card-item').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // æ›´æ–°è´¹ç”¨æ˜¾ç¤ºï¼ˆè™½ç„¶è´¹ç”¨æ²¡å˜ï¼Œä½†ä¸ºäº†é€»è¾‘ä¸¥è°¨ï¼‰
                updateCost();
                // --- æ ¸å¿ƒä¿®å¤ç»“æŸ ---

            } else {
                // å¦‚æœä½ç½®è¢«å ç”¨æˆ–è€…æ˜¯è¯¥å¡ç‰Œè‡ªå·±çš„æ—§ä½ç½®
                // è¿™é‡Œçš„é€»è¾‘ä¿æŒä¸å˜ï¼šå…è®¸ç‚¹å‡»è‡ªå·±çš„æ—§ä½ç½®æ¥â€œæ‹¿èµ·â€å¡ç‰Œï¼ˆå®é™…ä¸Šä»€ä¹ˆéƒ½ä¸åšï¼Œæˆ–è€…ä½ å¯ä»¥é€‰æ‹©åœ¨è¿™é‡Œä¹Ÿå–æ¶ˆé€‰ä¸­ï¼‰
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å·²æ”¾ç½®çš„å¡ç‰Œï¼ˆç”¨äºè°ƒæ•´ä½ç½®æ—¶çš„å®¹é”™ï¼‰
                const existingPlacement = gameState.placedCards.find(p => {
                    const pRow = Math.floor(p.cellIndex / 6);
                    const pCol = p.cellIndex % 6;
                    return cellIndex >= pRow * 6 + pCol && 
                           cellIndex < (pRow + p.card.height) * 6 + (pCol + p.card.width) &&
                           row >= pRow && row < pRow + p.card.height &&
                           col >= pCol && col < pCol + p.card.width;
                });
                
                // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ«çš„å¡ç‰Œï¼Œæˆ–è€…ä¸èƒ½æ”¾çš„åœ°æ–¹ï¼Œç›®å‰é€»è¾‘æ˜¯ç§»é™¤æ—§çš„ï¼ˆè¿™å¯èƒ½å¯¼è‡´è¯¯æ“ä½œï¼Œå»ºè®®ä¿ç•™åŸæ ·æˆ–ä»…æç¤ºï¼‰
                if (existingPlacement && existingPlacement.card.id === card.id) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯è‡ªå·±ï¼Œä»€ä¹ˆéƒ½ä¸åšï¼Œæˆ–è€…ä¹Ÿå¯ä»¥é€‰æ‹©åœ¨è¿™é‡Œå–æ¶ˆé€‰ä¸­è®©ç”¨æˆ·â€œæ”¾ä¸‹â€
                }
            }
        }
        
        // æ£€æŸ¥å¡ç‰Œæ˜¯å¦å¯ä»¥æ”¾ç½®
        function canPlaceCard(card, row, col) {
            const shape = card.shape;
            for (let i = 0; i < shape.length; i++) {
                for (let j = 0; j < shape[i].length; j++) {
                    if (shape[i][j] === 1) {
                        const gridRow = row + i;
                        const gridCol = col + j;
                        if (gridRow >= 6 || gridCol >= 6 || gridRow < 0 || gridCol < 0) {
                            return false;
                        }
                        
                        const targetCellIndex = gridRow * 6 + gridCol;
                        const targetCell = document.getElementById(`cell-${targetCellIndex}`);
                        if (targetCell && targetCell.classList.contains('occupied')) {
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        // åœ¨ç½‘æ ¼ä¸Šæ”¾ç½®å¡ç‰Œ
        function placeCardOnGrid(card, row, col) {
            const shape = card.shape;
            for (let i = 0; i < shape.length; i++) {
                for (let j = 0; j < shape[i].length; j++) {
                    if (shape[i][j] === 1) {
                        const gridRow = row + i;
                        const gridCol = col + j;
                        const cellIndex = gridRow * 6 + gridCol;
                        const cell = document.getElementById(`cell-${cellIndex}`);
                        
                        if (cell) {
                            cell.classList.add('occupied');
                            
                            // åªåœ¨ç¬¬ä¸€ä¸ªæ ¼å­æ˜¾ç¤ºå¡ç‰Œåç§°
                            if (i === 0 && j === 0) {
                                cell.innerHTML = `
                                    <div class="placed-card" style="background: ${card.color}; position: absolute; top: 0; left: 0; width: ${card.width * 50}px; height: ${card.height * 50}px; z-index: 10; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                        ${card.name}
                                    </div>
                                `;
                            } else {
                                // å…¶ä»–æ ¼å­åªæ˜¾ç¤ºé¢œè‰²å—
                                cell.innerHTML = `
                                    <div style="background: ${card.color}; opacity: 0.5; width: 100%; height: 100%; border-radius: 2px;"></div>
                                `;
                            }
                        }
                    }
                }
            }
            
            gameState.placedCards.push({ card, cellIndex: row * 6 + col });
        }

        // ç§»é™¤å·²æ”¾ç½®çš„å¡ç‰Œ
        function removePlacedCard(cardId) {
            gameState.placedCards = gameState.placedCards.filter(p => p.card.id !== cardId);
            
            // æ¸…é™¤ç½‘æ ¼ä¸­çš„æ‰€æœ‰ç›¸å…³æ ¼å­
            document.querySelectorAll('.grid-cell').forEach((cell, index) => {
                if (cell.classList.contains('occupied')) {
                    const cellCard = gameState.placedCards.find(p => {
                        const pRow = Math.floor(p.cellIndex / 6);
                        const pCol = p.cellIndex % 6;
                        const row = Math.floor(index / 6);
                        const col = index % 6;
                        return row >= pRow && row < pRow + p.card.height &&
                               col >= pCol && col < pCol + p.card.width;
                    });
                    
                    if (!cellCard || cellCard.card.id === cardId) {
                        cell.classList.remove('occupied');
                        cell.innerHTML = '';
                    }
                }
            });
        }

        // æ›´æ–°è´¹ç”¨æ˜¾ç¤ºï¼ˆä¿®å¤ç‰ˆï¼šè®¡ç®—å·²æ”¾ç½®å¡ç‰Œçš„æ€»å’Œï¼‰
        function updateCost() {
            // 1. è®¡ç®—æ£‹ç›˜ä¸Šæ‰€æœ‰å¡ç‰Œçš„è´¹ç”¨æ€»å’Œ
            const placedCost = gameState.placedCards.reduce((sum, p) => sum + p.card.cost, 0);
            
            // 2. è®¡ç®—å½“å‰é€‰ä¸­ï¼ˆæ‰‹é‡Œæ‹¿ç€ï¼‰çš„å¡ç‰Œè´¹ç”¨
            // æ³¨æ„ï¼šå¦‚æœé€‰ä¸­çš„å¡ç‰Œå·²ç»åœ¨æ£‹ç›˜ä¸Šäº†ï¼ˆåœ¨ç§»åŠ¨ä¸­ï¼‰ï¼Œä¸è¦é‡å¤è®¡ç®—å®ƒçš„è´¹ç”¨
            let selectedCost = 0;
            if (gameState.selectedCards.length > 0) {
                const card = gameState.selectedCards[0];
                const isAlreadyOnBoard = gameState.placedCards.some(p => p.card.id === card.id);
                if (!isAlreadyOnBoard) {
                    selectedCost = card.cost;
                }
            }

            const totalCost = placedCost + selectedCost;
            const costEl = document.getElementById('current-cost');
            
            if (costEl) {
                costEl.textContent = totalCost;
                // è§†è§‰åé¦ˆï¼šå¦‚æœè¶…æ”¯ï¼ˆè™½ç„¶é€»è¾‘ä¼šæ‹¦æˆªï¼‰ï¼Œæ˜¾ç¤ºçº¢è‰²ï¼›å¦åˆ™æ˜¾ç¤ºç»¿è‰²
                costEl.parentElement.style.color = totalCost > 10 ? '#ef4444' : '#07c160';
            }
        }

        // å¼€å§‹æˆ˜æ–—ï¼ˆå…³å¡æ¨¡å¼ï¼‰
        function startBattle() {
            if (gameState.placedCards.length === 0) {
                alert('è¯·è‡³å°‘æ”¾ç½®ä¸€å¼ å¡ç‰Œï¼');
                return;
            }
            
            if (!gameState.currentTerritory) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…³å¡ï¼');
                return;
            }
            
            // åœ¨å½“å‰é¡µé¢æ˜¾ç¤ºæˆ˜æ–—å†…å®¹
            initBattleInTerritory();
        }

        // åœ¨é¢†åœŸé¡µé¢åˆå§‹åŒ–æˆ˜æ–—
        function initBattleInTerritory() {
            // åˆ›å»ºæˆ˜æ–—ç•Œé¢
            const battleHTML = `
                <div class="mp-card" id="active-battle-card">
                    <button class="mp-button secondary" onclick="endBattle()">â† ç»“æŸæˆ˜æ–—</button>
                    <div id="battle-territory-info" style="padding: 15px; background: rgba(31, 41, 55, 0.1); border-radius: 8px; margin: 15px 0;">
                        <div style="color: #1f2937; font-size: 14px; font-weight: bold;">
                            ğŸ¯ æˆ˜æ–—ä¸­ï¼šç¬¬${gameState.currentTerritory.level}å…³ - ${gameState.currentTerritory.name}
                        </div>
                    </div>
                </div>

                <div class="mp-card">
                    <div class="mp-stats">
                        <div class="mp-stat-item">
                            <div class="mp-stat-value" id="player-units">0</div>
                            <div class="mp-stat-label">æˆ‘æ–¹å•ä½</div>
                        </div>
                        <div class="mp-stat-item">
                            <div class="mp-stat-value" id="enemy-units">0</div>
                            <div class="mp-stat-label">æ•Œæ–¹å•ä½</div>
                        </div>
                        <div class="mp-stat-item">
                            <div class="mp-stat-value" id="battle-time">0s</div>
                            <div class="mp-stat-label">æˆ˜æ–—æ—¶é—´</div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="color: #333; font-size: 16px;">æˆ˜æ–—åŠ é€Ÿ</h3>
                        <div class="speed-controls">
                            <span style="color: #666; font-size: 12px; margin-right: 5px;">é€Ÿåº¦:</span>
                            <button class="speed-btn active" onclick="setBattleSpeed(1)">1x</button>
                            <button class="speed-btn" onclick="setBattleSpeed(2)">2x</button>
                            <button class="speed-btn" onclick="setBattleSpeed(4)">4x</button>
                            <button class="speed-btn" onclick="setBattleSpeed(10)">10x</button>
                            <button class="speed-btn" onclick="setBattleSpeed(50)">50x</button>
                            <button class="speed-btn" onclick="setBattleSpeed(99)">99x</button>
                        </div>
                    </div>
                    
                    <div class="mp-battle-field" id="territory-battle-field">
                        </div>
                    
                    <button class="mp-button danger" onclick="endBattle()" style="margin-top: 15px; width: 100%;">ç»“æŸæˆ˜æ–—</button>
                </div>
                
                <div class="mp-card">
                    <h3 style="color: #333; margin-bottom: 10px; font-size: 16px;">æˆ˜æ–—è®°å½•</h3>
                    <div id="territory-battle-log" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            `;

            // æ›¿æ¢æˆ˜æ–—å‡†å¤‡è§†å›¾ä¸ºæˆ˜æ–—è§†å›¾
            const battlePrepView = document.getElementById('battle-prep-view');
            battlePrepView.style.display = 'block';
            battlePrepView.innerHTML = battleHTML;

            // åˆå§‹åŒ–æˆ˜æ–—å•ä½
            const battleField = document.getElementById('territory-battle-field');
            battleField.innerHTML = '';
            gameState.battleUnits = [];
            gameState.battleTime = 0;
            
            // ç”Ÿæˆç©å®¶å•ä½ï¼ˆæ¯å¼ å¡ç‰Œç”Ÿæˆå¤šä¸ªå•ä½ï¼‰- å¤§å¹…å¢å¼ºç©å®¶ä¼˜åŠ¿è‡³80%èƒœç‡
            gameState.placedCards.forEach(({ card }) => {
                const unitCount = 15 + Math.floor(Math.random() * 15); // 15-29ä¸ªå•ä½ï¼ˆå¤§å¹…å¢åŠ ï¼‰
                for (let i = 0; i < unitCount; i++) {
                    const unit = document.createElement('div');
                    unit.className = 'battle-unit player';
                    unit.style.left = Math.random() * 200 + 50 + 'px';
                    unit.textContent = card.icon;
                    unit.style.top = Math.random() * 300 + 50 + 'px';
                    battleField.appendChild(unit);
                    
                    // å¤§å¹…å¢å¼ºç©å®¶å•ä½å±æ€§
                    gameState.battleUnits.push({
                        element: unit,
                        team: 'player',
                        health: card.health * 1.5, // å¢åŠ 50%ç”Ÿå‘½å€¼
                        damage: (card.damage * 1.8) / unitCount, // å¢åŠ 80%ä¼¤å®³
                        x: parseFloat(unit.style.left),
                        y: parseFloat(unit.style.top),
                        icon: card.icon
                    });
                }
            });
            
            // æ ¹æ®å…³å¡ç”Ÿæˆæ•Œæ–¹å•ä½ - å¤§å¹…å‰Šå¼±æ•Œæ–¹ä»¥å®ç°8:2èƒœç‡ï¼ˆç©å®¶80%ï¼‰
            if (gameState.currentTerritory && gameState.currentTerritory.enemyCards) {
                gameState.currentTerritory.enemyCards.forEach(enemyCard => {
                    const unitCount = 4 + Math.floor(Math.random() * 4); // 4-7ä¸ªå•ä½ï¼ˆå¤§å¹…å‡å°‘ï¼‰
                    for (let i = 0; i < unitCount; i++) {
                        const unit = document.createElement('div');
                        unit.className = 'battle-unit enemy';
                        unit.textContent = enemyCard.icon;
                        unit.style.left = Math.random() * 200 + 500 + 'px';
                        unit.style.top = Math.random() * 300 + 50 + 'px';
                        battleField.appendChild(unit);
                        
                        // å¤§å¹…å‰Šå¼±æ•Œæ–¹å•ä½å±æ€§
                        gameState.battleUnits.push({
                            element: unit,
                            team: 'enemy',
                            health: enemyCard.hp * 0.5, // å‡å°‘50%ç”Ÿå‘½å€¼
                            damage: (enemyCard.damage * 0.4) / unitCount, // å‡å°‘60%ä¼¤å®³
                            x: parseFloat(unit.style.left),
                            y: parseFloat(unit.style.top),
                            icon: enemyCard.icon
                        });
                    }
                });
            } else {
                // é»˜è®¤æ•Œæ–¹å•ä½ - åŒæ ·å¤§å¹…å‰Šå¼±
                const enemyUnitCount = 5 + Math.floor(Math.random() * 3); // 5-7ä¸ªå•ä½
                for (let i = 0; i < enemyUnitCount; i++) {
                    const unit = document.createElement('div');
                        unit.className = 'battle-unit enemy';
                        unit.textContent = 'ğŸ‘º';
                        unit.style.left = Math.random() * 200 + 500 + 'px';
                        unit.style.top = Math.random() * 300 + 50 + 'px';
                        battleField.appendChild(unit);
                        
                        gameState.battleUnits.push({
                            element: unit,
                            team: 'enemy',
                            health: 50, // å¤§å¹…å‡å°‘ç”Ÿå‘½å€¼
                            damage: 4, // å¤§å¹…å‡å°‘ä¼¤å®³
                            x: parseFloat(unit.style.left),
                            y: parseFloat(unit.style.top),
                            icon: 'ğŸ‘º'
                        });
                }
            }
            
            updateBattleStats();
            startBattleSimulation();
        }

        // å¼€å§‹æˆ˜æ–—æ¨¡æ‹Ÿï¼ˆå¢å¼ºæ‰“å‡»æ„Ÿï¼‰
        function startBattleSimulation() {
            // é€‰æ‹©åˆé€‚çš„æˆ˜æ–—æ—¥å¿—å…ƒç´ 
            const battleLog = document.getElementById('territory-battle-log') || document.getElementById('battle-log-content');
            if (battleLog) {
                battleLog.innerHTML = '<div style="padding: 8px; background: #f8f8f8; border-radius: 6px; margin-bottom: 8px; font-size: 14px;">æˆ˜æ–—å¼€å§‹ï¼é€Ÿåº¦: ' + gameState.battleSpeed + 'x</div>';
            }
            
            const baseInterval = 200; // åŸºç¡€é—´éš”200ms
            const adjustedInterval = baseInterval / gameState.battleSpeed;
            
            gameState.battleInterval = setInterval(() => {
                gameState.battleTime += 1/gameState.battleSpeed;
                const battleTimeEl = document.getElementById('battle-time');
                if (battleTimeEl) {
                    battleTimeEl.textContent = Math.floor(gameState.battleTime) + 's';
                }
                
                // ç§»åŠ¨å•ä½
                gameState.battleUnits.forEach(unit => {
                    const moveSpeed = 2 * gameState.battleSpeed;
                    if (unit.team === 'player') {
                        unit.x = Math.min(unit.x + moveSpeed, 700);
                    } else {
                        unit.x = Math.max(unit.x - moveSpeed, 100);
                    }
                    unit.element.style.left = unit.x + 'px';
                });
                
                // ç®€å•çš„æˆ˜æ–—é€»è¾‘
                const playerUnits = gameState.battleUnits.filter(u => u.team === 'player' && u.health > 0);
                const enemyUnits = gameState.battleUnits.filter(u => u.team === 'enemy' && u.health > 0);
                
                if (playerUnits.length === 0 || enemyUnits.length === 0) {
                    endBattle();
                    return;
                }
                
                // éšæœºé€ æˆä¼¤å®³ (æ ¹æ®é€Ÿåº¦è°ƒæ•´æ¦‚ç‡)
                const damageChance = 0.7 - (0.1 * (gameState.battleSpeed - 1));
                
                if (Math.random() > damageChance && playerUnits.length > 0 && enemyUnits.length > 0) {
                    const target = enemyUnits[Math.floor(Math.random() * enemyUnits.length)];
                    const attacker = playerUnits[Math.floor(Math.random() * playerUnits.length)];
                    
                    // æ”»å‡»åŠ¨ç”»
                    attacker.element.classList.add('attacking');
                    setTimeout(() => attacker.element.classList.remove('attacking'), 300);
                    
                    target.health -= attacker.damage;
                    
                    // æ˜¾ç¤ºä¼¤å®³æ•°å­—
                    showDamageNumber(target.x, target.y, attacker.damage);
                    
                    if (target.health <= 0) {
                        createExplosion(target.x, target.y);
                        target.element.classList.add('hit');
                        setTimeout(() => {
                            if (target.element.parentNode) {
                                target.element.remove();
                            }
                        }, 300);
                        
                        if (battleLog) {
                            const logItem = document.createElement('div');
                            logItem.style.cssText = 'padding: 6px 8px; background: #d4f4dd; border-radius: 6px; margin-bottom: 4px; font-size: 13px; color: #333;';
                            logItem.textContent = 'ğŸ›¡ï¸ æˆ‘æ–¹å•ä½å‡»è´¥äº†æ•Œæ–¹ï¼';
                            battleLog.appendChild(logItem);
                        }
                    } else {
                        target.element.classList.add('hit');
                        setTimeout(() => target.element.classList.remove('hit'), 300);
                    }
                }
                
                if (Math.random() > damageChance && enemyUnits.length > 0 && playerUnits.length > 0) {
                    const target = playerUnits[Math.floor(Math.random() * playerUnits.length)];
                    const attacker = enemyUnits[Math.floor(Math.random() * enemyUnits.length)];
                    
                    // æ”»å‡»åŠ¨ç”»
                    attacker.element.classList.add('attacking');
                    setTimeout(() => attacker.element.classList.remove('attacking'), 300);
                    
                    target.health -= attacker.damage;
                    
                    // æ˜¾ç¤ºä¼¤å®³æ•°å­—
                    showDamageNumber(target.x, target.y, attacker.damage);
                    
                    if (target.health <= 0) {
                        createExplosion(target.x, target.y);
                        target.element.classList.add('hit');
                        setTimeout(() => {
                            if (target.element.parentNode) {
                                target.element.remove();
                            }
                        }, 300);
                        
                        if (battleLog) {
                            const logItem = document.createElement('div');
                            logItem.style.cssText = 'padding: 6px 8px; background: #ffebee; border-radius: 6px; margin-bottom: 4px; font-size: 13px; color: #333;';
                            logItem.textContent = 'ğŸ‘º æ•Œæ–¹å•ä½å‡»è´¥äº†æˆ‘æ–¹å•ä½ï¼';
                            battleLog.appendChild(logItem);
                        }
                    } else {
                        target.element.classList.add('hit');
                        setTimeout(() => target.element.classList.remove('hit'), 300);
                    }
                }
                
                updateBattleStats();
                
                // ä¿æŒæ—¥å¿—æ•°é‡åœ¨åˆç†èŒƒå›´å†…
                if (battleLog) {
                    const logItems = battleLog.children;
                    if (logItems.length > 10) {
                        battleLog.removeChild(logItems[logItems.length - 1]);
                    }
                }
                
            }, adjustedInterval);
        }

        // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
        function createExplosion(x, y) {
            const battleField = document.getElementById('territory-battle-field') || document.getElementById('battle-field');
            if (!battleField) return;
            
            const explosion = document.createElement('div');
            explosion.className = 'explosion';
            explosion.style.left = (x - 15) + 'px';
            explosion.style.top = (y - 15) + 'px';
            battleField.appendChild(explosion);
            
            setTimeout(() => {
                if (explosion.parentNode) {
                    explosion.remove();
                }
            }, 500);
        }

        // æ˜¾ç¤ºä¼¤å®³æ•°å­—
        function showDamageNumber(x, y, damage) {
            const battleField = document.getElementById('territory-battle-field') || document.getElementById('battle-field');
            if (!battleField) return;
            
            const damageNumber = document.createElement('div');
            damageNumber.className = 'damage-number';
            damageNumber.textContent = Math.floor(damage);
            damageNumber.style.left = x + 'px';
            damageNumber.style.top = y + 'px';
            battleField.appendChild(damageNumber);
            
            setTimeout(() => {
                if (damageNumber.parentNode) {
                    damageNumber.remove();
                }
            }, 1000);
        }

        // æ›´æ–°æˆ˜æ–—ç»Ÿè®¡
        function updateBattleStats() {
            const playerUnits = gameState.battleUnits.filter(u => u.team === 'player' && u.health > 0).length;
            const enemyUnits = gameState.battleUnits.filter(u => u.team === 'enemy' && u.health > 0).length;
            
            document.getElementById('player-units').textContent = playerUnits;
            document.getElementById('enemy-units').textContent = enemyUnits;
        }

        // ç»“æŸæˆ˜æ–—ï¼ˆå…³å¡æ¨¡å¼ï¼‰
        function endBattle() {
            if (gameState.battleInterval) {
                clearInterval(gameState.battleInterval);
                gameState.battleInterval = null;
            }
            
            const playerUnits = gameState.battleUnits.filter(u => u.team === 'player' && u.health > 0).length;
            const enemyUnits = gameState.battleUnits.filter(u => u.team === 'enemy' && u.health > 0).length;
            
            const victory = playerUnits > enemyUnits;
            
            // å…³å¡èƒœåˆ©å¤„ç†
            if (victory && gameState.currentTerritory) {
                const currentLevel = gameState.currentTerritory.level;
                
                // æ ‡è®°å…³å¡é€šè¿‡
                gameState.currentTerritory.purified = true;
                gameState.currentTerritory.owner = 'ç©å®¶';
                
                // åªè§£é”ä¸‹ä¸€å…³ï¼ˆä¿®å¤ï¼šä¸å†ä¸€æ¬¡æ€§è§£é”æ‰€æœ‰å…³å¡ï¼‰
                const nextLevel = currentLevel + 1;
                if (nextLevel <= 5) {
                    const nextTerritory = gameState.territories.find(t => t.level === nextLevel);
                    if (nextTerritory && !gameState.unlockedLevels.includes(nextLevel)) {
                        gameState.unlockedLevels.push(nextLevel);
                        addSocialMessage(`ğŸ‰ æ­å–œï¼ç¬¬${currentLevel}å…³å®Œæˆï¼Œè§£é”ç¬¬${nextLevel}å…³ï¼š${nextTerritory.name}ï¼`);
                    }
                }
                
                // å…³å¡å¥–åŠ±
                const levelReward = gameState.currentTerritory.enemyReward;
                gameState.gold += levelReward;
                updateStats();
                
                // æ˜¾ç¤ºæˆ˜æ–—ç»“æœ
                const territoryBattleLog = document.getElementById('territory-battle-log') || document.getElementById('battle-log-content');
                if (territoryBattleLog) {
                    const logItem = document.createElement('div');
                    logItem.style.cssText = 'padding: 8px 12px; background: rgba(34, 197, 94, 0.3); border-radius: 8px; margin-bottom: 8px; font-size: 14px; color: #1a1a1a; font-weight: bold;';
                    logItem.textContent = `ğŸ‰ ç¬¬${currentLevel}å…³èƒœåˆ©ï¼è·å¾—${levelReward}é‡‘å¸ï¼`;
                    territoryBattleLog.appendChild(logItem);
                }
                
                // æ¸…é™¤å¤±è´¥è®°å½•
                gameState.lastFailedTerritory = null;
                
                // æ˜¾ç¤ºèƒœåˆ©ç•Œé¢ï¼Œæä¾›è¿”å›åœ°å›¾é€‰é¡¹
                setTimeout(() => {
                    showVictoryInterface(levelReward, currentLevel, nextLevel);
                }, 800);
                
                return;
            }
            
            // æˆ˜è´¥å¤„ç†
            const goldReward = 30;
            gameState.gold += goldReward;
            updateStats();
            
            // è®°å½•å¤±è´¥å…³å¡ï¼Œä¾¿äºç«‹å³é‡è¯•
            gameState.lastFailedTerritory = gameState.currentTerritory;
            
            const territoryBattleLog = document.getElementById('territory-battle-log') || document.getElementById('battle-log-content');
            if (territoryBattleLog) {
                const logItem = document.createElement('div');
                logItem.style.cssText = 'padding: 8px 12px; background: rgba(239, 68, 68, 0.2); border-radius: 8px; margin-bottom: 8px; font-size: 14px; color: #1a1a1a;';
                logItem.textContent = 'æŒ‘æˆ˜å¤±è´¥ï¼Œè·å¾—30é‡‘å¸é¼“åŠ±å¥–ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç«‹å³é‡è¯•';
                territoryBattleLog.appendChild(logItem);
            }
            
            // æ˜¾ç¤ºå¤±è´¥é€‰é¡¹æŒ‰é’® - ç«‹å³é‡è¯•åŠŸèƒ½
            setTimeout(() => {
                showFailureInterface(goldReward);
            }, 500);
        }

        // åˆå§‹åŒ–ç¤¾äº¤ç³»ç»Ÿ
        function initSocial() {
            updateFactionDisplay();
            renderFriends();
            updateSocialFeed();
        }

        // é€‰æ‹©é˜µè¥
        function selectFaction(faction) {
            gameState.faction = faction;
            
            // è·å–æ‰€æœ‰é˜µè¥æŒ‰é’®å¹¶ç§»é™¤activeç±»
            document.querySelectorAll('[id^="faction-"]').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ ¹æ®é€‰æ‹©æ·»åŠ activeç±»
            const selectedBtn = document.getElementById(`faction-${faction}`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
            
            updateFactionDisplay();
        }

        // æ›´æ–°é˜µè¥æ˜¾ç¤º
        function updateFactionDisplay() {
            const factionDisplay = document.getElementById('faction-display');
            const abilities = document.getElementById('faction-abilities');
            
            if (gameState.faction === 'knight') {
                factionDisplay.innerHTML = 'ğŸ›¡ï¸ éª‘å£«';
                abilities.innerHTML = `
                    <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <h4 style="color: #333; font-size: 14px; margin-bottom: 8px;">çš‡å®¶éª‘å£«ç‰¹æƒ</h4>
                        <p style="color: #666; font-size: 13px; margin-bottom: 4px;">â€¢ äº«æœ‰æ•™çˆ¶èˆ¬å—äººæ•¬ä»°çš„è£è€€</p>
                        <p style="color: #666; font-size: 13px; margin-bottom: 4px;">â€¢ å¯ä»¥ç»™æ–°äººå‘æ”¾å…æ­»é‡‘ç‰Œ</p>
                        <p style="color: #666; font-size: 13px; margin-bottom: 10px;">â€¢ å¯ä»¥åœ¨ç¾¤é‡Œå‘é€ç‰¹æ•ˆçº¢åŒ…</p>
                        <button onclick="sendRedPacket()" class="mp-button" style="width: 100%;">
                            ğŸ å‘é€ç¾¤ä½“çº¢åŒ… (200é‡‘å¸)
                        </button>
                    </div>
                `;
            } else {
                factionDisplay.innerHTML = 'ğŸ‘¹ å“¥å¸ƒæ—';
                abilities.innerHTML = `
                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px; border-left: 4px solid #ef4444;">
                        <h4 style="color: #333; font-size: 14px; margin-bottom: 8px;">å“¥å¸ƒæ—ç‰¹æƒ</h4>
                        <p style="color: #666; font-size: 13px; margin-bottom: 4px;">â€¢ èƒŒåˆºè·å¾—åŒå€é‡‘å¸å¥–åŠ±</p>
                        <p style="color: #666; font-size: 13px; margin-bottom: 4px;">â€¢ ä½“éªŒä¸¾ä¸–çš†æ•Œçš„åˆºæ¿€æ„Ÿ</p>
                        <p style="color: #666; font-size: 13px; margin-bottom: 10px;">â€¢ æˆä¸ºå…¨æœé€šç¼‰çš„ç„¦ç‚¹</p>
                        <button onclick="becomeWorldBoss()" class="mp-button danger" style="width: 100%;">
                            ğŸ‘¹ æˆä¸ºä¸–ç•ŒBOSS
                        </button>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“å¥½å‹åˆ—è¡¨
        function renderFriends() {
            const container = document.getElementById('friends-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            gameState.friends.forEach(friend => {
                const friendEl = document.createElement('div');
                friendEl.className = 'mp-friend-item';
                friendEl.innerHTML = `
                    <div class="mp-friend-info">
                        <div class="mp-friend-avatar">${friend.avatar}</div>
                        <div class="mp-friend-details">
                            <div class="mp-friend-name">${friend.name}</div>
                            <div class="mp-friend-faction">${friend.faction === 'knight' ? 'çš‡å®¶éª‘å£«' : 'å“¥å¸ƒæ—'}</div>
                        </div>
                    </div>
                    <div class="mp-action-buttons">
                        <button class="mp-action-btn" style="background: #07c160; color: white;" onclick="helpFriend('${friend.id}')">
                            å¸®åŠ© (50)
                        </button>
                        <button class="mp-action-btn" style="background: #ff4757; color: white;" onclick="betrayFriend('${friend.id}')">
                            èƒŒåˆº (+100)
                        </button>
                    </div>
                `;
                container.appendChild(friendEl);
            });
        }

        // å¸®åŠ©å¥½å‹
        function helpFriend(friendId) {
            if (gameState.gold < 50) {
                addSocialMessage('é‡‘å¸ä¸è¶³ï¼éœ€è¦50é‡‘å¸æ‰èƒ½å¸®åŠ©å¥½å‹');
                return;
            }
            
            gameState.gold -= 50;
            updateStats();
            
            const friend = gameState.friends.find(f => f.id == friendId);
            addSocialMessage(`ä½ å¸®åŠ©äº†${friend.name}ï¼Œè·å¾—äº†å¥½æ„Ÿåº¦ï¼`);
            addSocialMessage(`${friend.name}: "æ„Ÿè°¢ä½ çš„å¸®åŠ©ï¼"`);
        }

        // èƒŒå›å¥½å‹ï¼ˆå¢å¼ºåé¦ˆï¼‰
        function betrayFriend(friendId) {
            const friend = gameState.friends.find(f => f.id == friendId);
            const bonus = gameState.faction === 'goblin' ? 200 : 100;
            
            gameState.gold += bonus;
            updateStats();
            
            // èƒŒåˆºæ•ˆæœï¼šå…¨å±çº¢è‰²é—ªçƒ + éœ‡åŠ¨
            triggerBetrayalEffect();
            
            addSocialMessage(`ä½ èƒŒå›äº†${friend.name}ï¼Œå¤ºèµ°äº†${bonus}é‡‘å¸ï¼`);
            addSocialMessage(`${friend.name}: "ä½ è¿™ä¸ªå›å¾’ï¼æˆ‘è¦åœ¨ç¾¤é‡Œæ­å‘ä½ ï¼"`);
            
            setTimeout(() => {
                addSocialMessage('å¾®ä¿¡ç¾¤æ¶ˆæ¯ï¼šæœ‰äººè¢«èƒŒå›äº†ï¼å¤§å®¶å°å¿ƒè¿™ä¸ªå›å¾’ï¼');
            }, 2000);
        }

        // èƒŒåˆºæ•ˆæœ
        function triggerBetrayalEffect() {
            // å…¨å±çº¢è‰²é—ªçƒ
            const flash = document.createElement('div');
            flash.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 0, 0, 0.8);
                z-index: 9999;
                animation: betrayalFlash 0.5s ease-out forwards;
                pointer-events: none;
            `;
            
            // æ·»åŠ é—ªçƒåŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes betrayalFlash {
                    0% { opacity: 0; }
                    20% { opacity: 1; }
                    40% { opacity: 0.3; }
                    60% { opacity: 1; }
                    80% { opacity: 0.3; }
                    100% { opacity: 0; }
                }
                @keyframes betrayShake {
                    0%, 100% { transform: translate(0, 0); }
                    10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 0); }
                    20%, 40%, 60%, 80% { transform: translate(5px, 0); }
                }
                .betrayal-shake {
                    animation: betrayShake 0.5s ease-out;
                }
            `;
            document.head.appendChild(style);
            
            // éœ‡åŠ¨ä¸»ä½“å†…å®¹
            document.body.classList.add('betrayal-shake');
            
            document.body.appendChild(flash);
            
            // è­¦å‘Šæ–‡å­—
            const warning = document.createElement('div');
            warning.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: white;
                font-size: 24px;
                font-weight: bold;
                text-shadow: 0 0 10px rgba(0,0,0,0.8);
                z-index: 10000;
                animation: warningPulse 0.5s ease-out forwards;
                pointer-events: none;
            `;
            warning.textContent = 'âš ï¸ èƒŒåˆºæˆåŠŸï¼';
            
            const warningStyle = document.createElement('style');
            warningStyle.textContent = `
                @keyframes warningPulse {
                    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
                    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
                    100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
                }
            `;
            document.head.appendChild(warningStyle);
            
            document.body.appendChild(warning);
            
            // æ¸…ç†æ•ˆæœ
            setTimeout(() => {
                document.body.removeChild(flash);
                document.body.removeChild(warning);
                document.body.classList.remove('betrayal-shake');
                document.head.removeChild(style);
                document.head.removeChild(warningStyle);
            }, 500);
        }

        // å‘é€çº¢åŒ…
        function sendRedPacket() {
            if (gameState.faction !== 'knight') {
                addSocialMessage('åªæœ‰çš‡å®¶éª‘å£«æ‰èƒ½å‘é€ç¾¤ä½“çº¢åŒ…ï¼');
                return;
            }
            
            if (gameState.gold < 200) {
                addSocialMessage('é‡‘å¸ä¸è¶³ï¼éœ€è¦200é‡‘å¸æ‰èƒ½å‘é€çº¢åŒ…');
                return;
            }
            
            gameState.gold -= 200;
            updateStats();
            
            addSocialMessage(`ä½ åœ¨å¾®ä¿¡ç¾¤å‘é€äº†200é‡‘å¸çš„å¤§çº¢åŒ…ï¼`);
            addSocialMessage('ç¾¤æˆå‘˜çº·çº·æ„Ÿè°¢ä½ çš„æ…·æ…¨ï¼');
            addSocialMessage('å¼ ä¸‰: "è°¢è°¢å¤§ä½¬çš„çº¢åŒ…ï¼ğŸ§§"');
            addSocialMessage('æå››: "å¤ªæ…·æ…¨äº†ï¼respectï¼ğŸ™"');
        }

        // æˆä¸ºä¸–ç•ŒBOSS
        function becomeWorldBoss() {
            if (gameState.faction !== 'goblin') {
                addSocialMessage('åªæœ‰å“¥å¸ƒæ—æ‰èƒ½æˆä¸ºä¸–ç•ŒBOSSï¼');
                return;
            }
            
            addSocialMessage('ä½ æˆä¸ºäº†å…¨æœé€šç¼‰çš„ä¸–ç•ŒBOSSï¼');
            addSocialMessage('æ‰€æœ‰ç©å®¶å‡»è´¥ä½ éƒ½æœ‰åŒå€å¥–åŠ±ï¼');
            addSocialMessage('å¿«æ¥ä½“éªŒä¸¾ä¸–çš†æ•Œçš„åˆºæ¿€æ„Ÿï¼');
        }

        // æ·»åŠ ç¤¾äº¤æ¶ˆæ¯
        function addSocialMessage(message) {
            gameState.socialFeed.unshift(message);
            if (gameState.socialFeed.length > 10) {
                gameState.socialFeed.pop();
            }
            updateSocialFeed();
        }

        // æ›´æ–°ç¤¾äº¤åŠ¨æ€
        function updateSocialFeed() {
            const container = document.getElementById('social-feed-content');
            if (!container) return;
            
            container.innerHTML = '';
            
            gameState.socialFeed.forEach(message => {
                const messageEl = document.createElement('div');
                messageEl.className = 'feed-item';
                messageEl.textContent = message;
                container.appendChild(messageEl);
            });
        }

        // åˆå§‹åŒ–é¢†åœŸç³»ç»Ÿ
        function initTerritory() {
            showLevelSelection(); // é»˜è®¤æ˜¾ç¤ºå…³å¡é€‰æ‹©è§†å›¾
            renderWorldMap();
            updateTerritoryStats();
        }

        // æ¸²æŸ“ä¸–ç•Œåœ°å›¾ï¼ˆå…³å¡é€‰æ‹©ç³»ç»Ÿï¼‰
        function renderWorldMap() {
            const worldMap = document.getElementById('world-map');
            if (!worldMap) {
                console.error('world-mapå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            worldMap.innerHTML = '';
            
            gameState.territories.forEach((territory, index) => {
                const territoryEl = document.createElement('div');
                territoryEl.className = 'mp-territory-map-item';
                
                // æ£€æŸ¥æ˜¯å¦è§£é” - åªæœ‰ç¬¬ä¸€å…³æˆ–å‰ä¸€å…³å®Œæˆæ‰è§£é”
                const isFirstLevel = territory.level === 1;
                const previousLevelCompleted = territory.level > 1 && 
                    gameState.territories.find(t => t.level === territory.level - 1)?.purified;
                const isUnlocked = isFirstLevel || previousLevelCompleted;
                const isCompleted = territory.purified && territory.owner === 'ç©å®¶';
                
                // æ›´æ–°è§£é”çŠ¶æ€
                if (isUnlocked && !gameState.unlockedLevels.includes(territory.level)) {
                    gameState.unlockedLevels.push(territory.level);
                }
                
                // æ·»åŠ å…³å¡å®Œæˆå¼•å¯¼åŠ¨ç”»ï¼ˆå°çº¢ç‚¹ï¼‰
                if (index === 0 || previousLevelCompleted) {
                    if (!isCompleted && isUnlocked) {
                        territoryEl.style.position = 'relative';
                        territoryEl.innerHTML += `
                            <div class="level-guide-dot" style="
                                position: absolute;
                                top: -8px;
                                right: -8px;
                                width: 12px;
                                height: 12px;
                                background: #ef4444;
                                border-radius: 50%;
                                border: 2px solid white;
                                animation: pulse-dot 2s infinite;
                                z-index: 10;
                            "></div>
                        `;
                    }
                }
                
                if (isCompleted) {
                    territoryEl.classList.add('purified');
                    territoryEl.innerHTML = `
                        <div>âœ…</div>
                        <div style="font-weight: 600; font-size: 10px; margin: 2px 0;">${territory.name}</div>
                        <div style="color: #07c160; font-size: 9px;">å·²å é¢†</div>
                        <div style="color: #f59e0b; font-size: 9px; font-weight: bold;">+${territory.resources}/æ—¶</div>
                    `;
                    
                    // ä¸ºå·²å é¢†æ®ç‚¹æ·»åŠ é˜²å®ˆæŒ‰é’®
                    territoryEl.onclick = () => {
                        showDefenseOptions(territory);
                    };
                    territoryEl.style.cursor = 'pointer';
                } else if (isUnlocked) {
                    territoryEl.classList.add('enemy');
                    territoryEl.innerHTML = `
                        <div>âš”ï¸</div>
                        <div style="font-weight: 600; font-size: 10px; margin: 2px 0;">${territory.name}</div>
                        <div style="color: #ff4757; font-size: 9px;">å¯æŒ‘æˆ˜</div>
                    `;
                } else {
                    territoryEl.classList.add('locked');
                    territoryEl.innerHTML = `
                        <div>ğŸ”’</div>
                        <div style="font-weight: 600; font-size: 10px; margin: 2px 0;">${territory.name}</div>
                        <div style="color: #999; font-size: 9px;">æœªè§£é”</div>
                    `;
                }
                
                territoryEl.style.left = territory.x + 'px';
                territoryEl.style.top = territory.y + 'px';
                
                if (isUnlocked) {
                    territoryEl.onclick = () => selectLevel(territory);
                    territoryEl.style.cursor = 'pointer';
                } else {
                    territoryEl.style.cursor = 'not-allowed';
                }
                
                worldMap.appendChild(territoryEl);
            });
            
            updateTerritoryStats();
        }

        // æ¸²æŸ“é¢†åœŸåˆ—è¡¨
        function renderTerritoryList() {
            const container = document.getElementById('territory-list-content');
            if (!container) return;
            
            container.innerHTML = '';
            
            gameState.territories.forEach(territory => {
                const territoryEl = document.createElement('div');
                territoryEl.className = 'mp-territory';
                
                const status = territory.purified ? 
                    (territory.owner === 'ç©å®¶' ? 'âœ… å·²æ”¶å¤' : 'ğŸ° ä»–å›½') : 
                    'ğŸ’€ æœªå‡€åŒ–';
                
                territoryEl.innerHTML = `
                    <div class="mp-territory-info">
                        <div class="mp-territory-name">${territory.name}</div>
                        <div class="mp-territory-status">çŠ¶æ€: ${status}</div>
                        <div class="mp-territory-resource">äº§é‡: +${territory.resources}/å°æ—¶</div>
                    </div>
                    <div>
                        ${(!territory.purified || territory.owner !== 'ç©å®¶') ? 
                            `<button class="mp-action-btn" style="background: #ff4757; color: white;" onclick="conquerTerritory(gameState.territories.find(t => t.id === ${territory.id}))">
                                å¾æœ (100)
                            </button>` : 
                            `<button class="mp-action-btn" style="background: #3b82f6; color: white;" onclick="setupDefense(${territory.id})">
                                å¸ƒé˜²
                            </button>`
                        }
                    </div>
                `;
                
                container.appendChild(territoryEl);
            });
        }

        // æ˜¾ç¤ºå…³å¡é€‰æ‹©è§†å›¾
        function showLevelSelection() {
            document.getElementById('level-selection-view').style.display = 'block';
            document.getElementById('battle-prep-view').style.display = 'none';
        }

        // æ˜¾ç¤ºæˆ˜æ–—å‡†å¤‡è§†å›¾ï¼ˆä¿®å¤ç‰ˆï¼šæ¯æ¬¡éƒ½é‡å»º HTML ç»“æ„ï¼‰
        function showBattlePreparation(territory) {
            // 1. åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
            document.getElementById('level-selection-view').style.display = 'none';
            const battlePrepView = document.getElementById('battle-prep-view');
            battlePrepView.style.display = 'block';
            
            // 2. ã€æ ¸å¿ƒä¿®å¤ã€‘å¿…é¡»åœ¨è¿™é‡Œé‡æ–°å†™å…¥ HTML ç»“æ„ï¼
            // å› ä¸ºä¹‹å‰çš„èƒœåˆ©/å¤±è´¥ç•Œé¢è¦†ç›–äº†è¿™é‡Œçš„å†…å®¹ï¼Œå¦‚æœä¸é‡å†™ï¼Œ
            // initPreparation() å°±ä¼šæ‰¾ä¸åˆ° id="card-grid" ä»è€ŒæŠ¥é”™å¡æ­»ã€‚
            battlePrepView.innerHTML = `
                <div class="mp-card">
                    <button class="mp-button secondary" onclick="showLevelSelection()">â† è¿”å›å…³å¡é€‰æ‹©</button>
                    <div id="selected-level-info" style="padding: 15px; background: rgba(31, 41, 55, 0.1); border-radius: 8px; margin: 15px 0;">
                        </div>
                </div>

                <div class="mp-card">
                    <h3 style="color: #333; margin-bottom: 15px; font-size: 16px;">é€‰æ‹©å¡ç‰Œ (è´¹ç”¨é™åˆ¶: 10)</h3>
                    <div style="color: #07c160; margin-bottom: 10px; font-weight: 500;">
                        å½“å‰è´¹ç”¨: <span id="current-cost">0</span>/10
                    </div>
                    <div class="card-grid" id="card-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        </div>
                </div>
                
                <div class="mp-card">
                    <h3 style="color: #333; margin-bottom: 15px; font-size: 16px;">æˆ˜åœºå¸ƒç½®</h3>
                    <div class="battle-grid" id="battle-grid" style="margin: 0 auto; width: fit-content;">
                        </div>
                    <button class="mp-button" onclick="startBattle()" style="margin: 15px auto 0; display: block;">å¼€å§‹æˆ˜æ–—</button>
                </div>
            `;
            
            // 3. ç»“æ„é‡å»ºå®Œæ¯•åï¼Œå†è°ƒç”¨åˆå§‹åŒ–å‡½æ•°
            // è¿™æ—¶å€™é¡µé¢ä¸Šå·²ç»æœ‰äº† card-grid å’Œ battle-gridï¼Œä¸ä¼šæŠ¥é”™äº†
            initPreparation();
            
            // 4. æ›´æ–°å…³å¡ä¿¡æ¯æ–‡å­—
            const levelInfo = document.getElementById('selected-level-info');
            if (levelInfo) {
                levelInfo.innerHTML = `
                    <div style="color: #1f2937; font-size: 16px; font-weight: bold; margin-bottom: 8px;">
                        ğŸ¯ ç¬¬${territory.level}å…³ - ${territory.name}
                    </div>
                    <div style="display: flex; gap: 20px; margin-bottom: 8px;">
                        <div style="color: #666; font-size: 13px;">
                            ğŸ‘¹ æ•Œäºº: ${territory.enemyCards ? territory.enemyCards.length : 0} å¼ å¡ç‰Œ
                        </div>
                        <div style="color: #f59e0b; font-size: 13px;">
                            ğŸ’° å¥–åŠ±: ${territory.enemyReward} é‡‘å¸
                        </div>
                    </div>
                    <div style="color: ${territory.purified && territory.owner === 'ç©å®¶' ? '#07c160' : '#ef4444'}; font-size: 13px;">
                        çŠ¶æ€: ${territory.purified && territory.owner === 'ç©å®¶' ? 'âœ… å·²å®Œæˆï¼ˆå¯é‡å¤æŒ‘æˆ˜ï¼‰' : 'ğŸ”¥ æœªå®Œæˆ'}
                    </div>
                `;
            }
        }

        // é€‰æ‹©å…³å¡
        function selectLevel(territory) {
            // æ£€æŸ¥æ˜¯å¦å·²è§£é” - ä½¿ç”¨æ›´ä¸¥æ ¼çš„è§£é”æ£€æŸ¥
            const isFirstLevel = territory.level === 1;
            const previousLevelCompleted = territory.level > 1 && 
                gameState.territories.find(t => t.level === territory.level - 1)?.purified;
            const isUnlocked = isFirstLevel || previousLevelCompleted;
            
            if (!isUnlocked) {
                addSocialMessage(`è¯·å…ˆå®Œæˆç¬¬${territory.level - 1}å…³æ‰èƒ½è§£é”æ­¤å…³å¡ï¼`);
                return;
            }
            
            // è®¾ç½®å½“å‰é€‰æ‹©çš„å…³å¡
            gameState.currentTerritory = territory;
            
            // é‡ç½®æˆ˜æ–—çŠ¶æ€
            gameState.selectedCards = [];
            gameState.placedCards = [];
            
            // æ˜¾ç¤ºæˆ˜æ–—å‡†å¤‡è§†å›¾
            showBattlePreparation(territory);
            
                // æ˜¾ç¤ºé€‰æ‹©æç¤º
                const statusText = territory.purified && territory.owner === 'ç©å®¶' ? 
                    `é‡æ–°æŒ‘æˆ˜ç¬¬${territory.level}å…³ï¼š${territory.name}` : 
                    `å¼€å§‹æŒ‘æˆ˜ç¬¬${territory.level}å…³ï¼š${territory.name}`;
                addSocialMessage(statusText + 'ï¼Œå‡†å¤‡ä½ çš„å¡ç‰Œé˜µå®¹ï¼');
        }

        // æ˜¾ç¤ºå…³å¡å®Œæˆå¼•å¯¼åŠ¨ç”»
        function showLevelCompleteGuide(completedLevel) {
            const nextLevel = completedLevel + 1;
            if (nextLevel > 5) return; // å·²å®Œæˆæ‰€æœ‰å…³å¡
            
            const worldMap = document.getElementById('world-map');
            const completedTerritory = gameState.territories.find(t => t.level === completedLevel);
            const nextTerritory = gameState.territories.find(t => t.level === nextLevel);
            
            if (!completedTerritory || !nextTerritory) return;
            
            // åˆ›å»ºè§£é”ç‰¹æ•ˆ
            const unlockEffect = document.createElement('div');
            unlockEffect.className = 'level-unlock-effect';
            unlockEffect.style.left = nextTerritory.x + 'px';
            unlockEffect.style.top = nextTerritory.y + 'px';
            worldMap.appendChild(unlockEffect);
            
            setTimeout(() => {
                if (unlockEffect.parentNode) {
                    unlockEffect.remove();
                }
            }, 1500);
            
            // åˆ›å»ºè¿çº¿åŠ¨ç”»
            setTimeout(() => {
                const connection = document.createElement('div');
                connection.className = 'unlock-connection';
                
                // è®¡ç®—è¿çº¿ä½ç½®å’Œè§’åº¦
                const startX = completedTerritory.x + 35;
                const startY = completedTerritory.y + 35;
                const endX = nextTerritory.x + 35;
                const endY = nextTerritory.y + 35;
                
                const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                const angle = Math.atan2(endY - startY, endX - startX) * (180 / Math.PI);
                
                connection.style.width = distance + 'px';
                connection.style.left = startX + 'px';
                connection.style.top = startY + 'px';
                connection.style.transform = `rotate(${angle}deg)`;
                
                worldMap.appendChild(connection);
                
                // 3ç§’åç§»é™¤è¿çº¿
                setTimeout(() => {
                    if (connection.parentNode) {
                        connection.remove();
                    }
                }, 3000);
            }, 500);
            
            // æ˜¾ç¤ºè§£é”æç¤º
            setTimeout(() => {
                addSocialMessage(`ğŸ‰ ç¬¬${completedLevel}å…³å®Œæˆï¼æ–°å…³å¡"${nextTerritory.name}"å·²è§£é”ï¼`);
            }, 800);
        }

        // æ˜¾ç¤ºèƒœåˆ©ç•Œé¢ï¼ˆè®©ç©å®¶è¿”å›åœ°å›¾é€‰æ‹©ä¸‹ä¸€å…³ï¼‰
        function showVictoryInterface(goldReward, currentLevel, nextLevel) {
            const battlePrepView = document.getElementById('battle-prep-view');
            if (!battlePrepView) return;
            
            const isLastLevel = currentLevel >= 5;
            const nextTerritory = gameState.territories.find(t => t.level === nextLevel);
            
            const victoryHTML = `
                <div class="victory-interface" style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 1s ease-in-out;">ğŸ‰</div>
                    <h2 style="color: #059669; font-size: 28px; font-weight: bold; margin-bottom: 15px;">
                        æ­å–œèƒœåˆ©ï¼
                    </h2>
                    <div style="background: linear-gradient(135deg, #d4f4dd 0%, #b7e4c7 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <p style="color: #1a1a1a; font-size: 18px; margin-bottom: 10px;">
                            âœ… ç¬¬${currentLevel}å…³å®Œæˆï¼
                        </p>
                        <p style="color: #059669; font-size: 20px; font-weight: bold;">
                            ğŸ’° è·å¾— ${goldReward} é‡‘å¸å¥–åŠ±
                        </p>
                        ${!isLastLevel ? `
                            <p style="color: #666; font-size: 14px; margin-top: 10px;">
                                ğŸ”“ å·²è§£é”ç¬¬${nextLevel}å…³ï¼š${nextTerritory?.name || ''}
                            </p>
                        ` : `
                            <p style="color: #f59e0b; font-size: 16px; margin-top: 10px; font-weight: bold;">
                                ğŸŠ æ­å–œé€šå…³æ‰€æœ‰å…³å¡ï¼
                            </p>
                        `}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 12px; max-width: 300px; margin: 0 auto;">
                        <button class="mp-button primary" onclick="returnToMap()" style="width: 100%; padding: 15px; font-size: 16px;">
                            ğŸ—ºï¸ è¿”å›åœ°å›¾
                        </button>
                        <button class="mp-button secondary" onclick="showPhase('main-menu')" style="width: 100%; padding: 12px;">
                            ğŸ  è¿”å›ä¸»èœå•
                        </button>
                    </div>
                </div>
            `;
            
            battlePrepView.innerHTML = victoryHTML;
            
            // æ›´æ–°åœ°å›¾æ˜¾ç¤º
            renderWorldMap();
            if (!isLastLevel && nextTerritory) {
                showLevelCompleteGuide(currentLevel);
            }
        }
        
        // è¿”å›åœ°å›¾ï¼ˆèƒœåˆ©åï¼‰
        function returnToMap() {
            gameState.currentTerritory = null;
            gameState.selectedCards = [];
            gameState.placedCards = [];
            gameState.battleUnits = [];
            
            // æ¸…ç†æˆ˜æ–—å®šæ—¶å™¨ï¼Œé˜²æ­¢åå°è¿˜åœ¨è·‘
            if (gameState.battleInterval) {
                clearInterval(gameState.battleInterval);
                gameState.battleInterval = null;
            }

            showLevelSelection();
            
            // å¼ºåˆ¶é‡æ–°æ¸²æŸ“åœ°å›¾ï¼Œç¡®ä¿å…³å¡è§£é”çŠ¶æ€ï¼ˆå°çº¢ç‚¹å’Œé¢œè‰²ï¼‰æ›´æ–°
            renderWorldMap();
        }

        // æ˜¾ç¤ºå¤±è´¥ç•Œé¢ï¼ˆå«ç«‹å³é‡è¯•å…¥å£ï¼‰
        function showFailureInterface(goldReward) {
            const battlePrepView = document.getElementById('battle-prep-view');
            if (!battlePrepView) return;

            const failureHTML = `
                <div class="failure-interface">
                    <div style="font-size: 64px; margin-bottom: 20px;">ğŸ˜”</div>
                    <h3 class="failure-title">æŒ‘æˆ˜å¤±è´¥</h3>
                    <p class="failure-description">
                        æŒ‘æˆ˜å¤±è´¥ï¼Œè·å¾—${goldReward}é‡‘å¸é¼“åŠ±å¥–ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç«‹å³é‡è¯•
                    </p>
                    <div class="failure-buttons">
                        <button class="retry-button" onclick="retryLevel()">
                            ğŸ”„ å†è¯•ä¸€æ¬¡
                        </button>
                        <button class="back-to-menu-button" onclick="showPhase('main-menu')">
                            ğŸ  è¿”å›ä¸»èœå•
                        </button>
                    </div>
                </div>
            `;

            battlePrepView.innerHTML = failureHTML;
        }

        // é‡è¯•å…³å¡
        function retryLevel() {
            const targetTerritory = gameState.currentTerritory || gameState.lastFailedTerritory;
            if (!targetTerritory) {
                showPhase('territory');
                return;
            }
            
            gameState.currentTerritory = targetTerritory;
            
            // é‡ç½®æˆ˜æ–—çŠ¶æ€
            gameState.selectedCards = [];
            gameState.placedCards = [];
            gameState.battleUnits = [];
            gameState.battleTime = 0;
            
            // é‡æ–°è¿›å…¥æˆ˜æ–—å‡†å¤‡
            showBattlePreparation(targetTerritory);
            
            addSocialMessage(`å‡†å¤‡é‡æ–°æŒ‘æˆ˜ç¬¬${targetTerritory.level}å…³ï¼š${targetTerritory.name}`);
        }

        // å¾æœé¢†åœŸï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼Œä½†ä¸»è¦ç”¨äºæ™®é€šé¢†åœŸï¼‰
        function conquerTerritory(territory) {
            if (territory.purified && territory.owner === 'ç©å®¶') {
                addSocialMessage('è¿™ä¸ªé¢†åœŸå·²ç»æ˜¯ä½ çš„äº†ï¼');
                return;
            }
            
            if (gameState.gold < 100) {
                addSocialMessage('é‡‘å¸ä¸è¶³ï¼éœ€è¦100é‡‘å¸æ‰èƒ½æ”»å é¢†åœŸ');
                return;
            }
            
            gameState.gold -= 100;
            updateStats();
            
            addSocialMessage(`æ­£åœ¨æ”»å ${territory.name}...`);
            
            setTimeout(() => {
                const success = Math.random() > 0.3; // 70% success rate
                
                if (success) {
                    territory.purified = true;
                    territory.owner = 'ç©å®¶';
                    gameState.gold += 50; // Battle reward
                    updateStats();
                    
                    addSocialMessage(`æˆåŠŸå¾æœäº†${territory.name}ï¼è·å¾—50é‡‘å¸å¥–åŠ±`);
                    addSocialMessage(`${territory.name}å·²å‡€åŒ–ï¼Œå¼€å§‹ä¸ºä½ ç”Ÿäº§èµ„æºï¼`);
                } else {
                    addSocialMessage(`ç¬¬${territory.level}å…³æŒ‘æˆ˜å¤±è´¥ï¼ŒæŸå¤±50é‡‘å¸`);
                    addSocialMessage('éœ€è¦é‡æ–°ç»„ç»‡å†›é˜Ÿå†æ¬¡æŒ‘æˆ˜ï¼');
                }
                
                renderWorldMap();
                renderTerritoryList();
            }, 2000);
        }

        // æ˜¾ç¤ºé˜²å®ˆé€‰é¡¹
        function showDefenseOptions(territory) {
            const battlePrepView = document.getElementById('battle-prep-view');
            if (!battlePrepView) return;
            
            // ç¡®ä¿ context æ˜¯å½“å‰çš„
            gameState.currentTerritory = territory; 

            document.getElementById('level-selection-view').style.display = 'none';
            battlePrepView.style.display = 'block';
            
            const optionsHTML = `
                <div class="mp-card">
                    <h2 style="text-align: center; margin-bottom: 20px; color: #333; font-size: 18px;">
                        ğŸ° ${territory.name}
                    </h2>
                    <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; margin-bottom: 20px;">
                        <div style="color: white; font-size: 14px; margin-bottom: 10px;">
                            âœ… é¢†åœ°çŠ¶æ€ï¼šå·²å é¢†
                        </div>
                        <div style="color: #fbbf24; font-size: 16px; font-weight: bold;">
                            ğŸ’° æŒç»­æ”¶ç›Šï¼š+${territory.resources} é‡‘å¸/å°æ—¶
                        </div>
                    </div>
                    <div style="display: grid; gap: 10px;">
                        <button class="mp-button primary" onclick="showDefenseSetup(gameState.currentTerritory)">
                            ğŸ›¡ï¸ è®¾ç½®é˜²å®ˆé˜µå‹
                        </button>
                        <button class="mp-button secondary" onclick="returnToMap()">
                            â† è¿”å›åœ°å›¾
                        </button>
                    </div>
                </div>
            `;
            
            battlePrepView.innerHTML = optionsHTML;
        }

        // è®¾ç½®é˜²å¾¡é˜µå‹
        function showDefenseSetup(territory) {
            gameState.currentTerritory = territory;
            gameState.selectedCards = [];
            gameState.placedCards = [];
            
            const battlePrepView = document.getElementById('battle-prep-view');
            if (!battlePrepView) return;
            
            const defenseHTML = `
                <div class="mp-card">
                    <button class="mp-button secondary" onclick="showDefenseOptions(gameState.currentTerritory)">
                        â† è¿”å›é¢†åœ°
                    </button>
                    
                    <h2 style="text-align: center; margin: 15px 0; color: #333; font-size: 18px;">
                        ğŸ›¡ï¸ é˜²å®ˆé˜µå‹è®¾ç½®
                    </h2>
                    
                    <div style="padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; margin-bottom: 15px;">
                        <div style="color: #667eea; font-weight: bold; margin-bottom: 5px;">
                            ${territory.name}
                        </div>
                        <div style="color: #666; font-size: 12px;">
                            ğŸ’° æ”¶ç›Šï¼š+${territory.resources} é‡‘å¸/å°æ—¶
                        </div>
                    </div>
                </div>

                <div class="mp-card">
                    <h3 style="color: #333; font-size: 14px; margin-bottom: 10px;">ğŸ“¦ é€‰æ‹©é˜²å®ˆå¡ç‰Œ (è´¹ç”¨ä¸Šé™: 10)</h3>
                    <div class="mp-stats" style="margin-bottom: 15px;">
                        <div class="mp-stat-item">
                            <div class="mp-stat-value"><span id="current-cost">0</span>/10</div>
                            <div class="mp-stat-label">æ€»è´¹ç”¨</div>
                        </div>
                        <div class="mp-stat-item">
                            <div class="mp-stat-value"><span id="selected-count">0</span>/8</div>
                            <div class="mp-stat-label">å·²é€‰å¡ç‰Œ</div>
                        </div>
                    </div>
                    
                    <div class="mp-card-grid" id="defense-card-list" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                        </div>
                </div>

                <div class="mp-card">
                    <h3 style="color: #333; font-size: 14px; margin-bottom: 10px;">ğŸ¯ å¸ƒç½®é˜²å®ˆé˜µå‹</h3>
                    <div class="mp-grid" id="defense-grid" style="display: grid; grid-template-columns: repeat(6, 45px); grid-template-rows: repeat(4, 45px); gap: 2px; margin: 0 auto; width: fit-content; background: rgba(0,0,0,0.1); padding: 5px; border-radius: 4px;">
                        </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div style="color: #1e40af; font-size: 12px; font-weight: bold; margin-bottom: 5px;">
                            ğŸ’¡ é˜²å®ˆè¯´æ˜
                        </div>
                        <div style="color: #64748b; font-size: 11px; line-height: 1.5;">
                            åœ¨æ­¤è®¾ç½®çš„é˜µå‹å°†ç”¨äºä¿æŠ¤å·²å é¢†æ®ç‚¹ã€‚åˆç†å¸ƒç½®é˜²å®ˆå•ä½ï¼Œå¯ä»¥æœ‰æ•ˆæŠµå¾¡æ•Œäººçš„è¿›æ”»ã€‚
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="mp-button secondary" style="flex: 1;" onclick="showDefenseOptions(gameState.currentTerritory)">
                            è¿”å›
                        </button>
                        <button class="mp-button primary" style="flex: 1;" onclick="saveDefenseSetup()">
                            ğŸ’¾ ä¿å­˜é˜µå‹
                        </button>
                    </div>
                </div>
            `;
            
            battlePrepView.innerHTML = defenseHTML;
            
            // æ¸²æŸ“å¡ç‰Œåˆ—è¡¨å’Œç½‘æ ¼
            renderDefenseCardList();
            renderDefenseGrid();
            updateDefenseCost();
        }

        // æ¸²æŸ“é˜²å®ˆå¡ç‰Œåˆ—è¡¨
        function renderDefenseCardList() {
            const cardList = document.getElementById('defense-card-list');
            if (!cardList) return;
            
            // ä½¿ç”¨å…¨å±€cardså˜é‡è€Œä¸æ˜¯allCards
            cardList.innerHTML = cards.map(card => {
                const isSelected = gameState.selectedCards.some(c => c.id === card.id);
                return `
                    <div class="mp-mini-card ${isSelected ? 'selected' : ''}" 
                         onclick="toggleDefenseCard(${JSON.stringify(card).replace(/"/g, '&quot;')})"
                         style="background: ${isSelected ? '#e0f2fe' : '#f9fafb'}; border: 1px solid ${isSelected ? '#3b82f6' : '#e5e7eb'}; border-radius: 6px; padding: 8px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <div style="font-size: 24px; margin-bottom: 4px;">${card.icon}</div>
                        <div style="font-size: 10px; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${card.name}</div>
                        <div style="font-size: 10px; color: #6b7280;">ğŸ’${card.cost}</div>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“é˜²å®ˆç½‘æ ¼
        function renderDefenseGrid() {
            const grid = document.getElementById('defense-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.style.background = 'rgba(255,255,255,0.8)';
                cell.style.border = '1px solid rgba(0,0,0,0.1)';
                cell.dataset.index = i;
                cell.onclick = () => placeDefenseCard(i);
                grid.appendChild(cell);
            }
            
            // æ˜¾ç¤ºå·²æ”¾ç½®çš„å¡ç‰Œ
            gameState.placedCards.forEach(placed => {
                const row = Math.floor(placed.cellIndex / 6);
                const col = placed.cellIndex % 6;
                
                for (let r = 0; r < placed.card.height; r++) {
                    for (let c = 0; c < placed.card.width; c++) {
                        const cellIndex = (row + r) * 6 + (col + c);
                        const cell = grid.children[cellIndex];
                        if (cell) {
                            cell.classList.add('occupied');
                            cell.style.background = 'rgba(59, 130, 246, 0.2)';
                            cell.style.borderColor = '#3b82f6';
                            
                            if (r === 0 && c === 0) {
                                cell.innerHTML = `
                                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative;">
                                        <div style="font-size: 20px;">${placed.card.icon}</div>
                                        <button onclick="event.stopPropagation(); removeDefenseCard('${placed.card.id}')" 
                                                style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">Ã—</button>
                                    </div>
                                `;
                            }
                        }
                    }
                }
            });
        }

        // åˆ‡æ¢é˜²å®ˆå¡ç‰Œé€‰æ‹©
        function toggleDefenseCard(card) {
            const index = gameState.selectedCards.findIndex(c => c.id === card.id);
            
            if (index >= 0) {
                gameState.selectedCards.splice(index, 1);
                // åŒæ—¶ç§»é™¤å·²æ”¾ç½®çš„è¯¥å¡ç‰Œ
                gameState.placedCards = gameState.placedCards.filter(p => p.card.id !== card.id);
            } else {
                if (gameState.selectedCards.length >= 8) {
                    alert('æœ€å¤šåªèƒ½é€‰æ‹©8å¼ å¡ç‰Œï¼');
                    return;
                }
                
                const totalCost = gameState.selectedCards.reduce((sum, c) => sum + c.cost, 0);
                if (totalCost + card.cost > 10) {
                    alert('æ€»è´¹ç”¨è¶…è¿‡10ï¼è¯·è°ƒæ•´å¡ç‰Œé€‰æ‹©');
                    return;
                }
                
                gameState.selectedCards.push(card);
            }
            
            renderDefenseCardList();
            renderDefenseGrid();
            updateDefenseCost();
        }

        // æ”¾ç½®é˜²å®ˆå¡ç‰Œ
        function placeDefenseCard(cellIndex) {
            if (gameState.selectedCards.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦æ”¾ç½®çš„å¡ç‰Œï¼');
                return;
            }
            
            // ç®€å•èµ·è§ï¼Œé˜²å®ˆæ¨¡å¼ä¸‹é»˜è®¤æ”¾ç½®æœ€åé€‰æ‹©çš„ä¸€å¼ å¡ç‰Œ
            // å®é™…é€»è¾‘å¯èƒ½éœ€è¦æ›´å¤æ‚çš„äº¤äº’ï¼ˆæ¯”å¦‚å…ˆç‚¹å¡å†ç‚¹æ ¼å­ï¼‰
            // è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹ä¸ºï¼šç‚¹å‡»æ ¼å­æ—¶ï¼Œæ”¾ç½®â€œå½“å‰æœªæ”¾ç½®çš„æœ€åä¸€å¼ é€‰ä¸­å¡ç‰Œâ€
            
            // æ‰¾åˆ°è¿˜æ²¡æœ‰æ”¾ç½®çš„å¡ç‰Œ
            const unplacedCard = [...gameState.selectedCards].reverse().find(card => 
                !gameState.placedCards.some(p => p.card.id === card.id)
            );
            
            if (!unplacedCard) {
                alert('æ‰€æœ‰é€‰ä¸­çš„å¡ç‰Œéƒ½å·²æ”¾ç½®ï¼Œæˆ–è¯·å…ˆé€‰æ‹©æ–°å¡ç‰Œï¼');
                return;
            }
            
            const card = unplacedCard;
            const row = Math.floor(cellIndex / 6);
            const col = cellIndex % 6;
            
            // æ£€æŸ¥è¾¹ç•Œ
            if (col + card.width > 6 || row + card.height > 4) {
                alert('æ”¾ç½®ä½ç½®è¶…å‡ºè¾¹ç•Œï¼');
                return;
            }
            
            // æ£€æŸ¥å ç”¨
            const grid = document.getElementById('defense-grid');
            for (let r = 0; r < card.height; r++) {
                for (let c = 0; c < card.width; c++) {
                    const checkIndex = (row + r) * 6 + (col + c);
                    if (grid.children[checkIndex]?.classList.contains('occupied')) {
                        alert('è¯¥ä½ç½®å·²è¢«å ç”¨ï¼');
                        return;
                    }
                }
            }
            
            gameState.placedCards.push({ card: card, cellIndex });
            renderDefenseGrid();
            updateDefenseCost(); // æ›´æ–°ä¸€ä¸‹çŠ¶æ€
        }

        // ç§»é™¤é˜²å®ˆå¡ç‰Œ
        function removeDefenseCard(cardId) {
            gameState.placedCards = gameState.placedCards.filter(p => p.card.id !== cardId);
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸ä»selectedCardsç§»é™¤ï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½æƒ³é‡æ–°æ”¾ç½®å®ƒ
            // å¦‚æœä½ æƒ³å½»åº•ç§»é™¤ï¼Œä¹Ÿå¯ä»¥æŠŠä¸‹é¢è¿™è¡ŒåŠ ä¸Šï¼š
            // gameState.selectedCards = gameState.selectedCards.filter(c => c.id !== Number(cardId));
            
            renderDefenseGrid();
            renderDefenseCardList(); // åˆ·æ–°åˆ—è¡¨é€‰ä¸­çŠ¶æ€
        }

        // æ›´æ–°é˜²å®ˆè´¹ç”¨æ˜¾ç¤º
        function updateDefenseCost() {
            const currentCost = gameState.selectedCards.reduce((sum, c) => sum + c.cost, 0);
            const costEl = document.getElementById('current-cost');
            const countEl = document.getElementById('selected-count');
            if (costEl) costEl.textContent = currentCost;
            if (countEl) countEl.textContent = gameState.selectedCards.length;
        }

        // ä¿å­˜é˜²å®ˆé˜µå‹
        function saveDefenseSetup() {
            if (gameState.placedCards.length === 0) {
                alert('è¯·è‡³å°‘æ”¾ç½®ä¸€å¼ å¡ç‰Œä½œä¸ºé˜²å®ˆï¼');
                return;
            }
            
            const territory = gameState.currentTerritory;
            alert(`${territory.name} çš„é˜²å®ˆé˜µå‹å·²ä¿å­˜ï¼`);
            
            setTimeout(() => {
                showDefenseOptions(territory);
            }, 500);
        }

        // è®¾ç½®é˜²å¾¡ï¼ˆæ—§å‡½æ•°ï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰
        function setupDefense(territoryId) {
            const territory = gameState.territories.find(t => t.id === territoryId);
            showDefenseOptions(territory);
        }

        // æ›´æ–°é¢†åœŸç»Ÿè®¡
        function updateTerritoryStats() {
            const completed = gameState.territories.filter(t => t.purified && t.owner === 'ç©å®¶').length;
            const totalRewards = gameState.territories
                .filter(t => t.purified && t.owner === 'ç©å®¶')
                .reduce((sum, t) => sum + t.enemyReward, 0);
            
            // è®¡ç®—æŒç»­æ”¶ç›Šï¼ˆæ¯å°æ—¶é‡‘å¸äº§å‡ºï¼‰
            const incomeRate = gameState.territories
                .filter(t => t.purified && t.owner === 'ç©å®¶')
                .reduce((sum, t) => sum + t.resources, 0);
            
            // æ‰¾åˆ°å½“å‰å¯æŒ‘æˆ˜çš„æœ€é«˜å…³å¡
            let currentChallengeLevel = 1;
            for (let i = 1; i <= 5; i++) {
                const territory = gameState.territories.find(t => t.level === i);
                if (territory && !territory.purified) {
                    currentChallengeLevel = i;
                    break;
                }
                if (i === 5 && territory?.purified) {
                    currentChallengeLevel = 5; // å…¨éƒ¨å®Œæˆ
                }
            }
            
            const currentLevelEl = document.getElementById('current-level-display');
            const completedEl = document.getElementById('completed-count');
            const totalRewardsEl = document.getElementById('total-rewards');
            const incomeRateEl = document.getElementById('income-rate');
            
            if (currentLevelEl) {
                if (completed === 5) {
                    currentLevelEl.textContent = 'å®Œæˆ';
                } else {
                    currentLevelEl.textContent = currentChallengeLevel;
                }
            }
            if (completedEl) completedEl.textContent = `${completed}/5`;
            if (totalRewardsEl) totalRewardsEl.textContent = totalRewards;
            if (incomeRateEl) incomeRateEl.textContent = incomeRate;
        }

        // å¼€å§‹èµ„æºç”Ÿæˆ
        function startResourceGeneration() {
            if (gameState.resourceInterval) {
                clearInterval(gameState.resourceInterval);
            }
            
            gameState.resourceInterval = setInterval(() => {
                const resourceRate = gameState.territories
                    .filter(t => t.purified && t.owner === 'ç©å®¶')
                    .reduce((sum, t) => sum + t.resources, 0);
                
                if (resourceRate > 0) {
                    gameState.gold += resourceRate / 60; // Per second
                    updateStats();
                }
            }, 1000);
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStats() {
            const goldEl = document.getElementById('gold');
            if (goldEl) {
                goldEl.textContent = Math.floor(gameState.gold);
            }
        }
        // ==========================================
    // æ–°å¢åŠŸèƒ½æ¨¡å—ï¼šé˜²å¾¡é˜µå‹ä¸ç‹å›½é‡å»ºç³»ç»Ÿ
    // ==========================================

    /**
     * è¦†ç›–åŸæœ‰çš„ saveDefenseSetup å‡½æ•°
     * åŠŸèƒ½ï¼šä¿å­˜é˜²å®ˆé˜µå‹ï¼Œæ¿€æ´»"é‡å»º"çŠ¶æ€ï¼Œæå‡èµ„æºäº§å‡º
     */
    function saveDefenseSetup() {
        if (gameState.placedCards.length === 0) {
            alert('âŒ ä¹Ÿå°±æ˜¯ç©ºåŸè®¡ï¼Ÿè¯·è‡³å°‘æ”¾ç½®ä¸€å¼ å¡ç‰Œä½œä¸ºé˜²å®ˆï¼');
            return;
        }

        const territory = gameState.currentTerritory;
        
        // 1. ä¿å­˜é˜²å®ˆæ•°æ®
        territory.defenseData = [...gameState.placedCards];
        territory.lastDefenseUpdate = new Date();

        // 2. æ¿€æ´»é‡å»ºå¥–åŠ± (å¦‚æœæ˜¯é¦–æ¬¡å¸ƒé˜²)
        if (!territory.isDefended) {
            territory.isDefended = true;
            const oldResources = territory.resources;
            // é‡å»ºå¥–åŠ±ï¼šèµ„æºäº§å‡ºæå‡ 50%
            territory.resources = Math.floor(territory.resources * 1.5);
            
            addSocialMessage(`ğŸ° ${territory.name} é˜²å¾¡å·¥äº‹å·²å»ºç«‹ï¼`);
            addSocialMessage(`ğŸ“ˆ é‡å»ºçº¢åˆ©ï¼šè¯¥åœ°åŒºèµ„æºäº§å‡ºä» ${oldResources} æå‡è‡³ ${territory.resources}/å°æ—¶ï¼`);
            
            // æ’­æ”¾ç‰¹æ•ˆï¼ˆè§†è§‰åé¦ˆï¼‰
            triggerRebuildEffect();
        } else {
            addSocialMessage(`ğŸ”„ ${territory.name} çš„é˜²å®ˆé˜µå‹å·²æ›´æ–°ã€‚`);
        }

        // 3. æ›´æ–°ç•Œé¢
        alert(`âœ… é˜²å®ˆé˜µå‹å·²ä¿å­˜ï¼\n\n${territory.name} æ­£åœ¨ç¹è£é‡å»ºä¸­...\nå½“å‰äº§å‡ºï¼š${territory.resources} é‡‘å¸/å°æ—¶`);
        
        // è¿”å›é˜²å®ˆé€‰é¡¹ç•Œé¢
        setTimeout(() => {
            showDefenseOptions(territory);
            updateStats(); // æ›´æ–°é¡¶éƒ¨çš„é‡‘å¸äº§å‡ºç‡æ˜¾ç¤º
        }, 500);
    }

    /**
     * è¦†ç›–åŸæœ‰çš„ showDefenseOptions å‡½æ•°
     * åŠŸèƒ½ï¼šå¢åŠ ç‹å›½é‡å»ºè¿›åº¦çš„å±•ç¤º
     */
    function showDefenseOptions(territory) {
        const battlePrepView = document.getElementById('battle-prep-view');
        if (!battlePrepView) return;
        
        // ç¡®ä¿ä¸Šä¸‹æ–‡æ­£ç¡®
        gameState.currentTerritory = territory; 
        document.getElementById('level-selection-view').style.display = 'none';
        battlePrepView.style.display = 'block';

        // è®¡ç®—ç‹å›½é‡å»ºçŠ¶æ€
        const kingdomStats = getKingdomStatus();
        
        const optionsHTML = `
            <div class="mp-card">
                <h2 style="text-align: center; margin-bottom: 10px; color: #1f2937; font-size: 18px;">
                    ğŸ° ${territory.name}
                </h2>
                
                <div style="padding: 20px; background: ${territory.isDefended ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)'}; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <div style="color: white; font-size: 14px; margin-bottom: 5px; opacity: 0.9;">
                        ${territory.isDefended ? 'âœ… å·²å»ºç«‹é˜²å¾¡ä½“ç³»' : 'âš ï¸ ä»…å é¢†ï¼Œæœªå¸ƒé˜²'}
                    </div>
                    <div style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 5px;">
                        +${territory.resources} <span style="font-size: 14px; font-weight: normal;">é‡‘å¸/å°æ—¶</span>
                    </div>
                    ${territory.isDefended ? 
                        `<div style="font-size: 10px; color: rgba(255,255,255,0.8); background: rgba(0,0,0,0.2); display: inline-block; padding: 2px 6px; border-radius: 4px;">ğŸ“ˆ åŒ…å«é‡å»ºçº¢åˆ© +50%</div>` 
                        : `<div style="font-size: 10px; color: #fbbf24;">ğŸ’¡ æç¤ºï¼šå»ºç«‹é˜²å®ˆå¯æå‡ 50% äº§å‡º</div>`}
                </div>

                <div style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <h3 style="color: #374151; font-size: 14px; font-weight: bold; margin-bottom: 10px;">ğŸ‘‘ å¤±è½ç‹å›½é‡å»ºè¿›åº¦</h3>
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #6b7280; margin-bottom: 5px;">
                        <span>å½“å‰ç§°å·: <strong style="color: #3b82f6;">${kingdomStats.title}</strong></span>
                        <span>ç¹è£åº¦: ${kingdomStats.progress}%</span>
                    </div>
                    <div style="width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                        <div style="width: ${kingdomStats.progress}%; height: 100%; background: #3b82f6; border-radius: 3px; transition: width 0.5s ease;"></div>
                    </div>
                    <div style="margin-top: 8px; font-size: 11px; color: #9ca3af;">
                        å·²å¸ƒé˜²é¢†åœŸ: ${kingdomStats.defendedCount} / ${gameState.territories.length}
                    </div>
                </div>

                <div style="display: grid; gap: 10px;">
                    <button class="mp-button primary" onclick="showDefenseSetup(gameState.currentTerritory)">
                        ${territory.isDefended ? 'ğŸ”„ è°ƒæ•´é˜²å®ˆé˜µå‹' : 'ğŸ›¡ï¸ å»ºç«‹é˜²å®ˆ (æ¿€æ´»å¥–åŠ±)'}
                    </button>
                    <button class="mp-button secondary" onclick="returnToMap()">
                        â† è¿”å›ä¸–ç•Œåœ°å›¾
                    </button>
                </div>
            </div>
        `;
        
        battlePrepView.innerHTML = optionsHTML;
    }

    /**
     * æ–°å¢è¾…åŠ©å‡½æ•°ï¼šè·å–ç‹å›½é‡å»ºçŠ¶æ€
     * è¿”å›ï¼šç§°å·ã€è¿›åº¦ç™¾åˆ†æ¯”ã€å·²é˜²å¾¡æ•°é‡
     */
    function getKingdomStatus() {
        const totalTerritories = gameState.territories.length;
        const defendedCount = gameState.territories.filter(t => t.isDefended).length;
        const progress = Math.floor((defendedCount / totalTerritories) * 100);
        
        let title = "æµäº¡è€…è¥åœ°";
        if (defendedCount >= 1) title = "å¤å…´çš„æ‘è½";
        if (defendedCount >= 3) title = "ç¹è£çš„åŸé‚¦";
        if (defendedCount >= 5) title = "å…‰è¾‰çš„å¸å›½";
        
        return {
            title,
            progress,
            defendedCount
        };
    }

    /**
     * æ–°å¢è¾…åŠ©å‡½æ•°ï¼šé‡å»ºæˆåŠŸçš„è§†è§‰ç‰¹æ•ˆ
     */
    function triggerRebuildEffect() {
        const flash = document.createElement('div');
        flash.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.6);
            z-index: 9999; pointer-events: none;
            animation: fadeOut 0.8s ease-out forwards;
        `;
        
        const style = document.createElement('style');
        style.textContent = `@keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }`;
        document.head.appendChild(style);
        document.body.appendChild(flash);
        
        setTimeout(() => {
            flash.remove();
            style.remove();
        }, 800);
    }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            
            // é»˜è®¤æ˜¾ç¤ºä¸»èœå•
            showPhase('main-menu');
            
            // æ¸¸æˆåˆ·æ–°åè‡ªåŠ¨é‡ç½®ï¼Œä¸ä¿å­˜è¿›åº¦
            console.log('æ¸¸æˆå·²åˆå§‹åŒ–ï¼Œåˆ·æ–°åå°†é‡ç½®æ‰€æœ‰è¿›åº¦');
        });
        // ==========================================
    // ç•Œé¢äº¤äº’ä¼˜åŒ–è¡¥ä¸
    // ==========================================

    /**
     * è¦†ç›– renderWorldMapï¼šè®©åœ°å›¾å›¾æ ‡æ›´æ˜ç¡®åœ°æç¤ºå¯ä»¥ç‚¹å‡»
     */
    function renderWorldMap() {
        const worldMap = document.getElementById('world-map');
        if (!worldMap) return;
        
        worldMap.innerHTML = '';
        
        gameState.territories.forEach((territory, index) => {
            const territoryEl = document.createElement('div');
            territoryEl.className = 'mp-territory-map-item';
            
            // æ£€æŸ¥è§£é”çŠ¶æ€
            const isFirstLevel = territory.level === 1;
            const previousLevelCompleted = territory.level > 1 && 
                gameState.territories.find(t => t.level === territory.level - 1)?.purified;
            const isUnlocked = isFirstLevel || previousLevelCompleted;
            const isCompleted = territory.purified && territory.owner === 'ç©å®¶';
            
            // æ›´æ–°è§£é”æ•°æ®
            if (isUnlocked && !gameState.unlockedLevels.includes(territory.level)) {
                gameState.unlockedLevels.push(territory.level);
            }
            
            // å¼•å¯¼çº¢ç‚¹
            if (index === 0 || previousLevelCompleted) {
                if (!isCompleted && isUnlocked) {
                    territoryEl.style.position = 'relative';
                    territoryEl.innerHTML += `<div class="level-guide-dot" style="position: absolute; top: -8px; right: -8px; width: 12px; height: 12px; background: #ef4444; border-radius: 50%; border: 2px solid white; animation: pulse-dot 2s infinite; z-index: 10;"></div>`;
                }
            }
            
            if (isCompleted) {
                territoryEl.classList.add('purified');
                // --- ä¿®æ”¹ç‚¹ï¼šæ–‡å­—æ”¹ä¸ºâ€œç‚¹å‡»å¸ƒé˜²â€ ---
                territoryEl.innerHTML = `
                    <div>ğŸ°</div>
                    <div style="font-weight: 600; font-size: 10px; margin: 2px 0;">${territory.name}</div>
                    <div style="color: #059669; font-size: 9px; font-weight: bold;">ğŸ‘‡ ç‚¹å‡»å¸ƒé˜²</div>
                    <div style="color: #f59e0b; font-size: 9px;">+${territory.resources}/æ—¶</div>
                `;
                
                // ç¡®ä¿ç‚¹å‡»äº‹ä»¶æ­£ç¡®ç»‘å®š
                territoryEl.onclick = () => {
                    console.log(`ç‚¹å‡»äº†é¢†åœŸ: ${territory.name}`); // è°ƒè¯•æ—¥å¿—
                    showDefenseOptions(territory);
                };
                territoryEl.style.cursor = 'pointer';
            } else if (isUnlocked) {
                territoryEl.classList.add('enemy');
                territoryEl.innerHTML = `
                    <div>âš”ï¸</div>
                    <div style="font-weight: 600; font-size: 10px; margin: 2px 0;">${territory.name}</div>
                    <div style="color: #ff4757; font-size: 9px;">ç‚¹å‡»æŒ‘æˆ˜</div>
                `;
                territoryEl.onclick = () => selectLevel(territory);
                territoryEl.style.cursor = 'pointer';
            } else {
                territoryEl.classList.add('locked');
                territoryEl.innerHTML = `
                    <div>ğŸ”’</div>
                    <div style="font-weight: 600; font-size: 10px; margin: 2px 0;">${territory.name}</div>
                    <div style="color: #999; font-size: 9px;">æœªè§£é”</div>
                `;
                territoryEl.style.cursor = 'not-allowed';
            }
            
            territoryEl.style.left = territory.x + 'px';
            territoryEl.style.top = territory.y + 'px';
            
            worldMap.appendChild(territoryEl);
        });
        
        updateTerritoryStats();
    }

    /**
     * è¦†ç›– renderTerritoryListï¼šè®©åˆ—è¡¨æŒ‰é’®æ›´æ˜¾çœ¼
     */
    function renderTerritoryList() {
        const container = document.getElementById('territory-list-content');
        if (!container) return;
        
        container.innerHTML = '';
        
        gameState.territories.forEach(territory => {
            const territoryEl = document.createElement('div');
            territoryEl.className = 'mp-territory';
            
            const status = territory.purified ? 
                (territory.owner === 'ç©å®¶' ? 'âœ… å·²æ”¶å¤' : 'ğŸ° ä»–å›½') : 
                'ğŸ’€ æœªå‡€åŒ–';
            
            territoryEl.innerHTML = `
                <div class="mp-territory-info">
                    <div class="mp-territory-name">${territory.name}</div>
                    <div class="mp-territory-status">çŠ¶æ€: ${status}</div>
                    <div class="mp-territory-resource">äº§é‡: +${territory.resources}/å°æ—¶</div>
                </div>
                <div>
                    ${(!territory.purified || territory.owner !== 'ç©å®¶') ? 
                        `<button class="mp-action-btn" style="background: #ff4757; color: white;" onclick="conquerTerritory(gameState.territories.find(t => t.id === ${territory.id}))">
                            âš”ï¸ å¾æœ
                        </button>` : 
                        // --- ä¿®æ”¹ç‚¹ï¼šæŒ‰é’®æ–‡å­—æ”¹ä¸ºâ€œå»ºç«‹é˜²å®ˆâ€ ---
                        `<button class="mp-action-btn" style="background: #3b82f6; color: white; box-shadow: 0 2px 5px rgba(59, 130, 246, 0.4);" onclick="setupDefense(${territory.id})">
                            ğŸ›¡ï¸ å»ºç«‹é˜²å®ˆ
                        </button>`
                    }
                </div>
            `;
            
            container.appendChild(territoryEl);
        });
    }

    // ç«‹å³åˆ·æ–°ç•Œé¢
    console.log("ç•Œé¢ä¼˜åŒ–è¡¥ä¸å·²åº”ç”¨");
    if(document.getElementById('world-map')) renderWorldMap();
    if(document.getElementById('territory-list-content')) renderTerritoryList();
    </script>
    <style>
    /* 1. ç¤¾äº¤é¡µé¢è¦†ç›–å±‚ (ä¿æŒåŸæœ‰æ·±è‰²è´¨æ„Ÿ) */
    #real-social-layer {
        display: none; position: fixed; top: 60px; left: 0; 
        width: 100%; height: calc(100% - 130px);
        background: #111; z-index: 8000; overflow-y: auto; padding: 15px;
        animation: slideInRight 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

    .social-header {
        display: flex; justify-content: space-between; align-items: center;
        padding-bottom: 15px; border-bottom: 1px solid #333; margin-bottom: 15px;
        color: white; font-weight: bold; font-size: 18px;
    }

    /* 2. å¡ç‰‡æ ·å¼ (åŸæœ‰è®¾è®¡) */
    .s-card {
        background: #1e1e1e; border-radius: 8px; padding: 15px; margin-bottom: 12px;
        border-left: 5px solid #555; position: relative;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.1s;
    }
    .s-card:active { transform: scale(0.98); }
    
    .sc-hero { border-left-color: #ff4d4d; background: linear-gradient(135deg, #2a1010, #1e1e1e); }
    .sc-help { border-left-color: #28a745; background: linear-gradient(135deg, #0a200a, #1e1e1e); }
    .sc-knight { border-left-color: #00d4ff; background: linear-gradient(135deg, #0a1a2a, #1e1e1e); }

    .sc-title { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-bottom: 8px; }
    .sc-desc { font-size: 13px; color: #ccc; line-height: 1.5; margin-bottom: 12px; }
    
    .sc-btn {
        float: right; padding: 6px 16px; border-radius: 20px; border: none; font-size: 12px;
        color: white; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    /* 3. æŠ‰æ‹©å¼¹çª— (ç”¨äºèƒŒåˆºé€»è¾‘) */
    #choice-modal {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 9999;
        justify-content: center; align-items: center;
    }
    .choice-box {
        width: 300px; background: #222; border: 1px solid #555; border-radius: 12px;
        padding: 20px; text-align: center; color: white;
    }
</style>

<div id="real-social-layer">
    <div class="social-header">
        <span>ğŸŒ å¾®ä¿¡å¥½å‹åŠ¨æ€</span>
        <span style="font-size:12px; color:#888; font-weight:normal;" id="msg-count">3æ¡æ–°æˆ˜å†µ</span>
    </div>

    <div class="s-card sc-hero">
        <div class="sc-title"><span style="color:#ff4d4d">ğŸ”¥ ææ€–é™ä¸´</span><span>15m</span></div>
        <div class="sc-desc">ç©å®¶ <b>"æš´èºçš®å¡"</b> å é¢†äº†çš‡åŸï¼æ‚¬èµé‡‘ 5000ã€‚å‡»è´¥ä»–å¤ºå›è£è€€ã€‚</div>
        <button class="sc-btn" style="background:#ff4d4d" onclick="triggerRealBattle('demon')">âš”ï¸ è®¨ä¼é­”ç‹</button>
        <div style="clear:both"></div>
    </div>

    <div class="s-card sc-help">
        <div class="sc-title"><span style="color:#28a745">ğŸ†˜ ç´§æ€¥æ±‚æ´</span><span>åˆšåˆš</span></div>
        <div class="sc-desc">å¥½å‹ <b>"çº¯çˆ±æˆ˜å£«"</b> è¯·æ±‚æ”¯æ´ï¼ä»–æ­£åœ¨é˜²å®ˆå“¥å¸ƒæ—å¤§å†›ã€‚</div>
        <button class="sc-btn" style="background:#28a745" onclick="openChoiceModal()">â• åŠ å…¥æˆ˜åœº</button>
        <div style="clear:both"></div>
    </div>

    <div class="s-card sc-knight">
        <div class="sc-title"><span style="color:#00d4ff">ğŸ›¡ï¸ çˆµä½æ™‹å‡</span><span>30m</span></div>
        <div class="sc-desc">çš‡å®¤æ­£åœ¨åˆ†å‘æœ¬å‘¨æ´¥è´´ã€‚</div>
        <button class="sc-btn" style="background:#007bff" onclick="triggerRealBattle('gift')">ğŸ é¢†å–æ´¥è´´</button>
        <div style="clear:both"></div>
    </div>
</div>

<div id="choice-modal">
    <div class="choice-box">
        <h3 style="color:#ffd700; margin-bottom:10px;">âš¡ æˆ˜åœºæŠ‰æ‹©</h3>
        <p style="font-size:13px; color:#ccc; margin-bottom:20px;">
            æ•Œæ–¹å‘æ¥å¯†ä¿¡ï¼š<br>
            "å¦‚æœä½ åœ¨è¿™ä¸ªå…³å¡å€’æˆˆï¼Œæˆ‘ç»™ä½  <b style="color:gold">2000é‡‘å¸</b>..."
        </p>
        <div style="display:flex; gap:10px; justify-content: center;">
            <button onclick="triggerRealBattle('aid')" style="padding:10px 20px; background:#28a745; border:none; border-radius:6px; color:white; cursor:pointer;">ğŸ›¡ï¸ å¿ è¯šæ”¯æ´</button>
            <button onclick="triggerRealBattle('betray')" style="padding:10px 20px; background:#800000; border:1px solid red; border-radius:6px; color:white; cursor:pointer;">ğŸ—¡ï¸ æ¥å—äº¤æ˜“ (èƒŒåˆº)</button>
        </div>
        <div style="margin-top:15px; font-size:12px; color:#666; cursor:pointer;" onclick="closeChoiceModal()">å–æ¶ˆ</div>
    </div>
</div>

<script>
    // =================================================================
    // [REAL BATTLE INJECTOR] å®æˆ˜æ³¨å…¥å™¨ v12.0
    // =================================================================

    // 1. å¯¼èˆªæ åŠ«æŒ (é€»è¾‘ä¿æŒä¸å˜ï¼šç‚¹å‡»ç¤¾äº¤æ˜¾ç¤ºè¦†ç›–å±‚)
    document.addEventListener('click', function(e) {
        let target = e.target;
        while (target && target !== document.body) {
            const text = target.innerText || "";
            // ç‚¹å‡»ç¤¾äº¤ -> æ˜¾ç¤ºå±‚
            if (text.includes("ç¤¾äº¤")) {
                document.getElementById('real-social-layer').style.display = 'block';
                break;
            }
            // ç‚¹å‡»å…¶ä»–å¯¼èˆª -> éšè—å±‚
            if (text.includes("é¢†åœŸ") || text.includes("æˆ˜æ–—") || text.includes("å•†åº—")) {
                document.getElementById('real-social-layer').style.display = 'none';
                break;
            }
            target = target.parentElement;
        }
    }, true);


    // 2. æ ¸å¿ƒï¼šè°ƒç”¨çœŸå®æˆ˜æ–—å¼•æ“
    // -----------------------------------------------------------------
    window.triggerRealBattle = function(type) {
        // å…³é—­ç¤¾äº¤å±‚ï¼Œè®©ç©å®¶çœ‹åˆ°åé¢çš„æ¸¸æˆç•Œé¢
        document.getElementById('real-social-layer').style.display = 'none';
        closeChoiceModal();

        // æ£€æŸ¥åŸä»£ç ä¸­æ˜¯å¦å­˜åœ¨ conquerTerritory å‡½æ•° (è¿™æ˜¯æˆ‘ä»¬åœ¨index.htmlé‡Œçœ‹åˆ°çš„)
        if (typeof conquerTerritory !== 'function') {
            alert("Error: æ‰¾ä¸åˆ°åŸæ¸¸æˆçš„ conquerTerritory å‡½æ•°ã€‚è¯·ç¡®ä¿ index.html åŒ…å«åŸºç¡€é€»è¾‘ã€‚");
            return;
        }

        // --- æ„é€ â€œè™šæ‹Ÿé¢†åœŸâ€å¯¹è±¡ ---
        // æˆ‘ä»¬åˆ©ç”¨ conquerTerritory æ¥å—å‚æ•°çš„ç‰¹æ€§ï¼Œä¼ å…¥ä¸€ä¸ªä¼ªé€ çš„å¯¹è±¡
        // è®©æ¸¸æˆå¼•æ“ä»¥ä¸ºæˆ‘ä»¬åœ¨æ‰“ä¸€ä¸ªæ™®é€šå…³å¡ï¼Œä½†å‚æ•°æ˜¯æˆ‘ä»¬å®šåˆ¶çš„
        let fakeTerritory = {
            id: 999 + Math.floor(Math.random()*100), // éšæœºIDé˜²æ­¢å†²çª
            name: "æœªçŸ¥åŒºåŸŸ",
            resources: 100, // åŸºç¡€å¥–åŠ±
            difficulty: 1,  // å‡è®¾åŸæ¸¸æˆæœ‰éš¾åº¦ç³»æ•°
            isSocial: true, // æ ‡è®°è¿™æ˜¯ç¤¾äº¤æˆ˜æ–—
            owner: 'System'
        };

        if (type === 'demon') {
            // [é­”ç‹æˆ˜]
            fakeTerritory.name = "ğŸ”¥ é­”ç‹åŸ (PVP)";
            fakeTerritory.desc = "å‡»è´¥æš´èºçš®å¡ï¼";
            // å‡è®¾åŸæ¸¸æˆæ ¹æ®IDæˆ–æŸäº›å±æ€§ç”Ÿæˆæ•Œäººï¼Œè¿™é‡Œæˆ‘ä»¬åªèƒ½ä¼ å…ƒæ•°æ®
            // å¦‚æœåŸæ¸¸æˆåªæ˜¯ç®€å•çš„æ•°å€¼æ¯”æ‹¼ï¼Œè¿™ä¸ªåå­—æ”¹äº†å°±å¤Ÿäº†
            // å¦‚æœæœ‰å…·ä½“çš„ enemy æ•°ç»„ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ³¨å…¥ï¼Œä¾‹å¦‚ï¼š
            fakeTerritory.customEnemies = ['P.E.K.K.A', 'Dragon']; 

        } else if (type === 'aid') {
            // [å¿ è¯šæ”¯æ´] - æ‰“å“¥å¸ƒæ—
            fakeTerritory.name = "ğŸ›¡ï¸ æ”¯æ´å‰çº¿";
            fakeTerritory.desc = "ä¸çº¯çˆ±æˆ˜å£«å¹¶è‚©ä½œæˆ˜";
            fakeTerritory.resources = 500; // å¥–åŠ±å£°æœ›

        } else if (type === 'betray') {
            // [èƒŒåˆº] - æ‰“å¥½å‹
            fakeTerritory.name = "ğŸ—¡ï¸ èƒŒåˆºè¡ŒåŠ¨";
            fakeTerritory.desc = "ä¸ºäº†é‡‘å¸å‡ºå–çµé­‚...";
            fakeTerritory.resources = 2000; // é«˜é¢æ‚¬èµ

        } else if (type === 'gift') {
            // [ç›´æ¥é¢†å¥–]
            alert("ğŸ‰ å·²é¢†å–çš‡å®¶æ´¥è´´ï¼š500é‡‘å¸ï¼");
            return; // ä¸è¿›å…¥æˆ˜æ–—
        }

        console.log("Starting Real Battle with:", fakeTerritory);

        // --- æ³¨å…¥ä¸å¯åŠ¨ ---
        
        // A. å°è¯•ä¿®æ”¹ç•Œé¢æ ‡é¢˜ (å¦‚æœå­˜åœ¨)
        const header = document.querySelector('.header-title') || document.querySelector('h1');
        if(header) header.innerText = "âš”ï¸ " + fakeTerritory.name;

        // B. è°ƒç”¨åŸæœ‰å‡½æ•°ï¼
        // è¿™ä¼šè§¦å‘åŸæ¸¸æˆçš„ï¼šåˆ‡æ¢è§†å›¾ -> æ¸²æŸ“æˆ˜æ–— -> è®¡ç®—ç»“æœ
        try {
            conquerTerritory(fakeTerritory);
            
            // C. æ—¢ç„¶æ˜¯å®æˆ˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸ª Toast æç¤ºç©å®¶ä»»åŠ¡ç›®æ ‡
            setTimeout(() => {
                const toast = document.createElement('div');
                toast.style.cssText = "position:fixed; top:20%; left:50%; transform:translate(-50%,0); background:rgba(0,0,0,0.8); color:#ffd700; padding:10px 20px; border-radius:20px; z-index:9000; font-weight:bold; pointer-events:none;";
                toast.innerText = "ğŸ¯ ä»»åŠ¡ç›®æ ‡: " + (type==='betray' ? "æ¶ˆç­å¥½å‹çš„é˜²å®ˆåŠ›é‡" : "å‡»è´¥æ•Œäºº");
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }, 500);

        } catch (e) {
            console.error(e);
            alert("å¯åŠ¨æˆ˜æ–—å¤±è´¥ï¼Œè¯·æ£€æŸ¥åŸä»£ç æ˜¯å¦åŠ è½½å®Œæ¯•ã€‚");
        }
    };

    // è¾…åŠ©å¼¹çª—æ§åˆ¶
    window.openChoiceModal = function() {
        document.getElementById('choice-modal').style.display = 'flex';
    };
    window.closeChoiceModal = function() {
        document.getElementById('choice-modal').style.display = 'none';
    };

    console.log("Pitch Patch v12.0: Real Battle Engine Connected.");
</script>
</body>
</html>
